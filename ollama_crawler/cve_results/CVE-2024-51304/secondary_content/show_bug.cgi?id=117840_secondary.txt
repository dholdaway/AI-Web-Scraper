Title: 117840 – [3.4/wrong-code] Postfix + VDA w/ -maccumulate-outgoing-args
URL: https://bugs.gentoo.org/show_bug.cgi?id=117840

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 117840
[3.4/wrong-code] Postfix + VDA w/ -maccumulate-outgoing-args
Last modified: 2007-01-15 06:53:22 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 117840 
      - [3.4/wrong-code] Postfix + VDA w/ -maccumulate-outgoing-args


Summary:
[3.4/wrong-code] Postfix + VDA w/ -maccumulate-outgoing-args
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

New packages

  (show other bugs)



Hardware:

All
        Linux
      







Importance:
      
High
       normal
      


Assignee:

Tuan Van (RETIRED)








URL:







Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2006-01-04 22:15 UTC by steveb





      Modified:
    
2007-01-15 06:53 UTC
      (History)
    




          CC List:
        

1 
          user
          
            (show)
          



net-mail+disabled









See Also:






Package list:







Runtime testing required:

---























      Attachments
    



Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


steveb





          2006-01-04 22:15:10 UTC
        

I had this issue already with gcc 3.4.4 and now with 3.4.5. When ever I compile Postfix with the VDA patch, then I get the following error while Postfix delivers to a virtual user:

Jan  5 06:58:56 mail postfix/qmgr[14713]: warning: premature end-of-input on private/virtual socket while reading input attribute name
Jan  5 06:58:56 mail postfix/qmgr[14713]: warning: private/virtual socket: malformed response
Jan  5 06:58:56 mail postfix/qmgr[14713]: warning: transport virtual failure -- see a previous warning/fatal/panic logfile record for the problem description
Jan  5 06:58:56 mail postfix/master[14707]: warning: process /usr/lib/postfix/virtual pid 14783 killed by signal 6
Jan  5 06:58:56 mail postfix/master[14707]: warning: /usr/lib/postfix/virtual: bad command startup -- throttling


Compiling with GCC 3.3.6 with exactly the same USE flags and CFLAGS/CXXFLAGS works without any problems.

Compiling Postfix without the VDA patch / vda USE flag does work without any problem (using GCC 3.3.6, 3.4.4, 3.4.5, 4.0.2, 4.1.0-beta20051230)




Comment 1


SpanKY






          2006-01-04 22:24:21 UTC
        

you neglected to post `emerge info`




Comment 2


steveb





          2006-01-04 22:28:45 UTC
        

(In reply to comment #1)
> you neglected to post `emerge info`
> 
Sorry!

Portage 2.0.53 (hardened/x86/2.6, gcc-3.4.5, glibc-2.3.5-r2, 2.6.15 i686)
=================================================================
System uname: 2.6.15 i686 AMD Athlon (TM)
Gentoo Base System version 1.6.14
distcc 2.18.3 i686-pc-linux-gnu (protocols 1 and 2) (default port 3632) [disabled]
ccache version 2.3 [disabled]
dev-lang/python:     2.3.5-r2, 2.4.2
sys-apps/sandbox:    1.2.12
sys-devel/autoconf:  2.13, 2.59-r6
sys-devel/automake:  1.4_p6, 1.5, 1.6.3, 1.7.9-r1, 1.8.5-r3, 1.9.6-r1
sys-devel/binutils:  2.16.1
sys-devel/libtool:   1.5.20
virtual/os-headers:  2.6.11-r3
ACCEPT_KEYWORDS="x86"
AUTOCLEAN="yes"
CBUILD="i686-pc-linux-gnu"
CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4 -maccumulate-outgoing-args"
CHOST="i686-pc-linux-gnu"
CONFIG_PROTECT="/etc /etc/mail/dspam /etc/postfix /usr/kde/2/share/config /usr/kde/3/share/config /usr/share/config /var/bind /var/qmail/control /var/run/dspam /var/spool/vacation"
CONFIG_PROTECT_MASK="/etc/gconf /etc/terminfo /etc/env.d"
CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4 -maccumulate-outgoing-args"
DISTDIR="/usr/portage/distfiles"
FEATURES="autoconfig buildpkg distlocks sandbox sfperms strict userpriv"
GENTOO_MIRRORS="ftp://sunsite.cnlab-switch.ch/mirror/gentoo http://www.ibiblio.org/pub/Linux/distributions/gentoo http://gentoo.oregonstate.edu/"
MAKEOPTS="-j2"
PKGDIR="/usr/portage/packages"
PORTAGE_TMPDIR="/var/tmp"
PORTDIR="/usr/portage"
PORTDIR_OVERLAY="/mnt/gentoo.overlay"
SYNC="rsync://rsync.gentoo.org/gentoo-portage"
USE="x86 GAPING_SECURITY_HOLE X509 acl acpi apache2 authdaemond autofs berkdb big-tables bzip2 cdb cgi crypt curl dlloader enscript erandom exif expat extraengine fam fastcgi ffmpeg fla freetds gd gd-external gdbm geoip gif gmp graphviz hardened icc icc-pgo idn imagemagick imap innodb inode ithreads j2ee java javacomm javamail jbig jboss jce jikes jms jmx jpeg jta kerberos krb4 large-domain lcms ldap libwww logrotate lzw lzw-tiff maildir mbox mcal mhash ming mmx mpeg mpm-worker mysql nagios-dns nagios-game nagios-ntp nagios-ping nagios-ssh ncurses netpbm neural nls nptl oav odbc pam pam-mysql pcre pdflib pear-db perl php pic png python readline rrdtool ruby samba sasl session silvercity skey snmp spell sqlite srp sse ssl svg svga svgz symlink tcpd threads tiff truetype udev urandom userlocales vda vhosts virtual-users wmf xml xml2 yaz zlib userland_GNU kernel_linux elibc_glibc"
Unset:  ASFLAGS, CTARGET, LANG, LC_ALL, LDFLAGS, LINGUAS






Comment 3


SpanKY






          2006-01-04 22:35:32 UTC
        

with CFLAGS like that i cant imagine why :P

does CFLAGS='-O2 -pipe' + gcc-3.4.5 yield a working system ?




Comment 4


steveb





          2006-01-04 22:43:24 UTC
        

(In reply to comment #3)
> with CFLAGS like that i cant imagine why :P
> 
> does CFLAGS='-O2 -pipe' + gcc-3.4.5 yield a working system ?
> 

YES! What now? Closing this bug? Or should I try to find out wich flag was/is the problem and then enhance the postfix ebuild to filter that flag out?




Comment 5


Mark Loeser (RETIRED)






          2006-01-04 22:45:30 UTC
        

If you could isolate the issue and find out what flag causes the problem, that would be helpful.  We could filter it, or we could try and actually get a fix for it upstream.




Comment 6


steveb





          2006-01-04 22:49:34 UTC
        

(In reply to comment #5)
> If you could isolate the issue and find out what flag causes the problem, that
> would be helpful.  We could filter it, or we could try and actually get a fix
> for it upstream.
> 

Okay. Give me some time to check out serval combinations of diefferent flags. Will keep you informed about my progress.




Comment 7


steveb





          2006-01-04 23:22:54 UTC
        

Works:
CFLAGS="-O2 -pipe" CXXFLAGS="-O2 -pipe" emerge -v postfix

CFLAGS="-march=athlon-tbird -Os -pipe" CXXFLAGS="-march=athlon-tbird -Os -pipe" emerge -v postfix

CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow" CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow" emerge -v postfix

CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer" CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer"   571  CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops" CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops" emerge -v postfix

CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4" CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4" emerge -v postfix

CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4" CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4" emerge -v postfix


Does not work:
CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4 -maccumulate-outgoing-args" CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4 -maccumulate-outgoing-args" emerge -v postfix

CFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -falign-functions=4 -maccumulate-outgoing-args" CXXFLAGS="-march=athlon-tbird -Os -pipe -mmmx -m3dnow -fforce-addr -fomit-frame-pointer -falign-functions=4 -maccumulate-outgoing-args" emerge -v postfix



Looks like the "-maccumulate-outgoing-args" flag is the guilty one. If you have VDA on your setup, could you try to compile with "-maccumulate-outgoing-args" and see if it is failing for you as well?

cheers

SteveB




Comment 8


steveb





          2006-01-04 23:44:12 UTC
        

This does not work as well:

CFLAGS="-Os -pipe -maccumulate-outgoing-args" CXXFLAGS="Os -pipe -maccumulate-outgoing-args" emerge -v postfix



It looks that realy the "-maccumulate-outgoing-args" flag is the problem.




Comment 9


Mark Loeser (RETIRED)






          2006-01-04 23:47:29 UTC
        

Is this issue only reproducible with 3.4.5?  Or does 4.x suffer from the same issue?

Also, thanks for reducing the flags for me.  Makes my life easier :)




Comment 10


steveb





          2006-01-05 00:01:04 UTC
        

(In reply to comment #9)
> Is this issue only reproducible with 3.4.5?  Or does 4.x suffer from the same
> issue?
> 
> Also, thanks for reducing the flags for me.  Makes my life easier :)
> 

I don't know. On the systems where I have 4.0.2 and 4.1.0 installed, Postifix does not have any virutal delivery enabled. I would need to change that and enable VDA in order to verify this issue with 4.x.

Do you want me to do that? Or do you have by accident a system with GCC 4.x and Postfix and VDA around where you could quickly test that?

cheers

SteveB




Comment 11


Mark Loeser (RETIRED)






          2006-01-05 00:12:51 UTC
        

If you could provide me with a minimal setup/set of steps to reproduce this, it would help a lot.  (Testing and letting me know on top of that would help as well) :)




Comment 12


Mark Loeser (RETIRED)






          2006-01-09 06:11:52 UTC
        

Perhaps you want to just filter this flag for the time being.




Comment 13


steveb





          2006-01-09 10:45:35 UTC
        

(In reply to comment #12)
> Perhaps you want to just filter this flag for the time being.
> 

Probably this ist the faster way of solving this issue?

Currently I am on my way to upgrade a (not so much important) system to gcc 4.0.2 and gcc 4.1.0-beta. Looks like I can't compile Cyrus-IMAPD with any of the 4-series of GCC. This is actualy holding me back from testing the issue with gcc 4.x. However... I did not forgett that I need to do this test. Will keep you informed about my progress.




Comment 14


Andrej Kacian (RETIRED)






          2006-01-23 13:22:38 UTC
        

I tried this with CFLAGS="-march=pentium4 -Os -pipe -mmmx -fforce-addr -fomit-frame-pointer -funroll-loops -falign-functions=4 -maccumulate-outgoing-args" as well as with my usual CFLAGS="-march=pentium4 -O2 -pipe -ggdb", but delivering to virtual users works all the time.

Perhaps you can post your postfix setup relevant to virtual domains. I have used a simple setup:

main.cf:
virtual_alias_domains = foo.sk
virtual_alias_maps = hash:/etc/postfix/virtual

virtual:
ticho@foo.sk	ticho
@foo.sk		root

BTW, I'm also using gcc-3.4.5 with the same profile as you. Which gcc profile do you use? (gcc-config -l)




Comment 15


steveb





          2006-01-23 13:37:47 UTC
        

(In reply to comment #14)
> I tried this with CFLAGS="-march=pentium4 -Os -pipe -mmmx -fforce-addr
> -fomit-frame-pointer -funroll-loops -falign-functions=4
> -maccumulate-outgoing-args" as well as with my usual CFLAGS="-march=pentium4
> -O2 -pipe -ggdb", but delivering to virtual users works all the time.
> 
> Perhaps you can post your postfix setup relevant to virtual domains. I have
> used a simple setup:
> 
> main.cf:
> virtual_alias_domains = foo.sk
> virtual_alias_maps = hash:/etc/postfix/virtual
> 
> virtual:
> ticho@foo.sk    ticho
> @foo.sk         root
> 
> BTW, I'm also using gcc-3.4.5 with the same profile as you. Which gcc profile
> do you use? (gcc-config -l)
> 

Try adding quota to the ticho@foo.sk mailbox and then try again. More info here: http://web.onda.com.br/nadal/




Comment 16


Andrej Kacian (RETIRED)






          2006-01-23 14:19:32 UTC
        

Ok, I tried this:

main.cf:
virtual_mailbox_limit_maps = hash:/etc/postfix/vquota

vquota:
ticho@foo.sk	100000000

Still, I get the mail okay:

Jan 23 23:15:17 src@thelair postfix/postfix-script: stopping the Postfix mail system 
Jan 23 23:15:17 src@thelair postfix/master[20220]: terminating on signal 15 
Jan 23 23:15:18 src@thelair postfix/postfix-script: starting the Postfix mail system 
Jan 23 23:15:18 src@thelair postfix/master[27982]: daemon started -- version 2.2.5, conf
iguration /etc/postfix 
Jan 23 23:15:21 src@thelair postfix/smtpd[2999]: connect from localhost[127.0.0.1] 
Jan 23 23:15:47 src@thelair postfix/smtpd[2999]: 28A583472F: client=localhost[127.0.0.1]

Jan 23 23:15:57 src@thelair postfix/cleanup[24601]: 28A583472F: message-id=<200601232215
29.28A583472F@thelair.ynet.sk>
Jan 23 23:15:57 src@thelair postfix/qmgr[3228]: 28A583472F: from=<asd@foo.cz>, size=368,
 nrcpt=1 (queue active)
Jan 23 23:15:57 src@thelair postfix/local[31993]: 28A583472F: to=<ticho@thelair.ynet.sk>
, orig_to=<ticho@foo.sk>, relay=local, delay=28, status=sent (delivered to command: /usr
/bin/procmail)
Jan 23 23:15:57 src@thelair postfix/qmgr[3228]: 28A583472F: removed 
Jan 23 23:15:59 src@thelair postfix/smtpd[2999]: disconnect from localhost[127.0.0.1] 

This all with ricey CFLAGS as mentioned above. Perhaps try removing your -march (or -m3dnow) ?

Anyway, this is best raised with postfix upstream developers, as they are the ones who can fix the code.




Comment 17


Mark Loeser (RETIRED)






          2006-01-29 11:08:57 UTC
        

This doesn't look like a toolchain issue since Ticho isn't having the same problems.




Comment 18


steveb





          2007-01-13 08:32:02 UTC
        

I think we should close this entry. It is now 1 year old. Can I close it?




Comment 19


Andrej Kacian (RETIRED)






          2007-01-13 17:03:35 UTC
        

(In reply to comment #18)
> I think we should close this entry. It is now 1 year old. Can I close it?
> 

That depends on whether you're still having the issue or not.




Comment 20


steveb





          2007-01-14 20:34:44 UTC
        

(In reply to comment #19)
> (In reply to comment #18)
> > I think we should close this entry. It is now 1 year old. Can I close it?
> > 
> 
> That depends on whether you're still having the issue or not.
> 
I moved ahead with GCC and with Postfix and with VDA. So to be honest: I have not anymore this issue. But I as well don't have anymore the setup described in this bug report.

So from my viewpoint we can close this bug.





Comment 21


Andrej Kacian (RETIRED)






          2007-01-15 06:53:22 UTC
        

Fair enough. I'm glad it's working for you now.









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


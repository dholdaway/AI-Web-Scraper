Title: 836326 – app-misc/mosquitto-2.0.14 does not start with memory_limit enabled
URL: https://bugs.gentoo.org/show_bug.cgi?id=836326

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 836326
app-misc/mosquitto-2.0.14 does not start with memory_limit enabled
Last modified: 2022-06-13 19:49:00 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 836326 
      - app-misc/mosquitto-2.0.14 does not start with memory_limit enabled


Summary:
app-misc/mosquitto-2.0.14 does not start with memory_limit enabled
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

Current packages

  (show other bugs)



Hardware:

All
        Linux
      







Importance:
      
Normal
       normal
      


Assignee:

Matt Turner








URL:



https://github.com/eclipse/mosquitto/...
        




Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2022-03-28 15:42 UTC by onkobu





      Modified:
    
2022-06-13 19:49 UTC
      (History)
    




          CC List:
        

1 
          user
          
            (show)
          



jstein









See Also:






Package list:







Runtime testing required:

---























      Attachments
    




build.log

              (build.log,80.36 KB,
                text/x-log)

            
2022-03-28 20:33 UTC,

            onkobu




Details





View All

Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


onkobu





          2022-03-28 15:42:03 UTC
        

When using a memory_limit in /etc/mosquitto/mosquitto.conf it does not start anymore. Instead a log message Invalid argument is written and service stops immediately.

Reproducible: Always

Steps to Reproduce:
1. enable memory_limit in configuration file, small value 4096 as well large values (32bit-64bit, depending on architecture)
2. start/ restart
Actual Results:  
Crashes/ stops, writes error message to log file.

Expected Results:  
Does not crash/ accepts memory limit.

Filed this already upstream. It was working before flawlessly with memory_limit. (I am not certain whether last emerge rebuilt only or updated, too)




Comment 1


Jonas Stein






          2022-03-28 18:06:44 UTC
        

Thank you for the report. We need to have all information at hand before ticket assignment. This includes
* the complete build.log as attachment and
* a paste of the emerge info 
as described on https://wiki.gentoo.org/wiki/Attach_the_logs_to_the_bug_ticket

Please add also the link to the upstream ticket here.




Comment 2


Jonas Stein






          2022-03-28 18:07:31 UTC
        

(my fault ;-) The link was at URL, where it was fine. https://github.com/eclipse/mosquitto/issues/2496




Comment 3


onkobu





          2022-03-28 20:11:56 UTC
        

Portage 3.0.30 (python 3.9.9-final-0, default/linux/amd64/17.1/no-multilib/hardened, gcc-11.2.1, glibc-2.34-r10, 5.15.23-gentoo-sec x86_64)
=================================================================
System uname: Linux-5.15.23-gentoo-sec-x86_64-AMD_Ryzen_5_3400G_with_Radeon_Vega_Graphics-with-glibc2.34
KiB Mem:    30822252 total,  29156240 free
KiB Swap:    4194300 total,   4194300 free
Timestamp of repository gentoo: Sun, 27 Mar 2022 00:45:01 +0000
Head commit of repository gentoo: 600d93ba48fad2419b0cc20874b336b31902edb3
sh bash 5.1_p16
ld GNU ld (Gentoo 2.37_p1 p2) 2.37
app-misc/pax-utils:        1.3.3::gentoo
app-shells/bash:           5.1_p16::gentoo
dev-java/java-config:      2.3.1::gentoo
dev-lang/perl:             5.34.0-r6::gentoo
dev-lang/python:           3.9.9-r1::gentoo, 3.10.2_p1::gentoo
dev-lang/rust:             1.58.1::gentoo
dev-util/cmake:            3.22.2::gentoo
dev-util/meson:            0.60.3::gentoo
sys-apps/baselayout:       2.7-r3::gentoo
sys-apps/openrc:           0.44.10::gentoo
sys-apps/sandbox:          2.29::gentoo
sys-devel/autoconf:        2.13-r1::gentoo, 2.71-r1::gentoo
sys-devel/automake:        1.16.4::gentoo
sys-devel/binutils:        2.37_p1-r2::gentoo
sys-devel/binutils-config: 5.4::gentoo
sys-devel/clang:           13.0.1::gentoo
sys-devel/gcc:             11.2.1_p20220115::gentoo
sys-devel/gcc-config:      2.5-r1::gentoo
sys-devel/libtool:         2.4.6-r6::gentoo
sys-devel/llvm:            13.0.1::gentoo
sys-devel/make:            4.3::gentoo
sys-kernel/linux-headers:  5.15-r3::gentoo (virtual/os-headers)
sys-libs/glibc:            2.34-r10::gentoo
Repositories:

gentoo
    location: /usr/portage
    sync-type: rsync
    sync-uri: rsync://rsync7.de.gentoo.org/gentoo-portage/
    priority: -1000
    sync-rsync-extra-opts: 
    sync-rsync-verify-metamanifest: yes
    sync-rsync-verify-max-age: 24
    sync-rsync-verify-jobs: 1

ACCEPT_KEYWORDS="amd64"
ACCEPT_LICENSE="@FREE"
CBUILD="x86_64-pc-linux-gnu"
CFLAGS="-march=athlon64 -O2 -pipe"
CHOST="x86_64-pc-linux-gnu"
CONFIG_PROTECT="/etc /etc/teamspeak3-server/ts3server.ini /etc/teamspeak3-server/ts3server_mariadb.ini /etc/teamspeak3-server/tsdns_settings.ini /usr/share/gnupg/qualified.txt /var/bind"
CONFIG_PROTECT_MASK="/etc/ca-certificates.conf /etc/dconf /etc/env.d /etc/fonts/fonts.conf /etc/gconf /etc/gentoo-release /etc/php/apache2-php7.4/ext-active/ /etc/php/apache2-php8.0/ext-active/ /etc/php/cgi-php7.4/ext-active/ /etc/php/cgi-php8.0/ext-active/ /etc/php/cli-php7.4/ext-active/ /etc/php/cli-php8.0/ext-active/ /etc/php/fpm-php7.4/ext-active/ /etc/php/fpm-php8.0/ext-active/ /etc/php/phpdbg-php7.4/ext-active/ /etc/php/phpdbg-php8.0/ext-active/ /etc/revdep-rebuild /etc/sandbox.d /etc/terminfo"
CXXFLAGS="-march=athlon64 -O2 -pipe"
DISTDIR="/var/portage/distfiles"
EMERGE_DEFAULT_OPTS="--quiet-build=y"
ENV_UNSET="CARGO_HOME DBUS_SESSION_BUS_ADDRESS DISPLAY GOBIN GOPATH PERL5LIB PERL5OPT PERLPREFIX PERL_CORE PERL_MB_OPT PERL_MM_OPT XAUTHORITY XDG_CACHE_HOME XDG_CONFIG_HOME XDG_DATA_HOME XDG_RUNTIME_DIR"
FCFLAGS="-march=athlon64 -O2 -pipe"
FEATURES="assume-digests binpkg-docompress binpkg-dostrip binpkg-logs buildpkg-live config-protect-if-modified distlocks ebuild-locks fixlafiles ipc-sandbox merge-sync multilib-strict network-sandbox news parallel-fetch pid-sandbox preserve-libs protect-owned qa-unresolved-soname-deps sandbox sfperms strict unknown-features-warn unmerge-logs unmerge-orphans userfetch userpriv usersandbox usersync xattr"
FFLAGS="-march=athlon64 -O2 -pipe"
GENTOO_MIRRORS="http://linux.rz.ruhr-uni-bochum.de/download/gentoo-mirror/"
LANG="en_US.utf8"
LDFLAGS="-Wl,-O1 -Wl,--as-needed"
MAKEOPTS="-j9"
PKGDIR="/var/portage/packages"
PORTAGE_BINHOST="https://biostar.voelkizetti.net/packages"
PORTAGE_CONFIGROOT="/"
PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --omit-dir-times --compress --force --whole-file --delete --stats --human-readable --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages --exclude=/.git"
PORTAGE_TMPDIR="/var/tmp"
SHELL="/bin/bash"
USE="aac acl alsa amd64 apache2 bzip2 crypt cups curl elogind ffmpeg flac gd gpg hardened iconv icu ipv6 jpeg json ldap libglvnd libtirpc lm_sensors mp3 mp4 mysqli ncurses nls nptl ogg openmp openssl opus pam pcre pdf php pie pkcs11 png postgres readline seccomp split-usr sqlite ssl ssp theora threads tiff udisks unicode vorbis xattr xml xtpax zlib" ABI_X86="64" ADA_TARGET="gnat_2020" APACHE2_MODULES="access_compat alias auth_basic authn_core authn_file authz_core authz_host authz_owner authz_user authn_dbm authz_dbm autoindex cache dav dav_fs dav_lock dbus dir env expires filter hal headers include log_config mime mime_magic negotiation proxy proxy_ajp proxy_html proxy_http proxy_wstunnel ratelimit rewrite socache_shmcb unique_id unixd userdir xml2enc" APACHE2_MPMS="worker" CALLIGRA_FEATURES="karbon sheets words" COLLECTD_PLUGINS="df interface irq load memory rrdtool swap syslog" CPU_FLAGS_X86="aes avx f16c fma3 fma4 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 sse4a ssse3 xop" ELIBC="glibc" GPSD_PROTOCOLS="ashtech aivdm earthmate evermore fv18 garmin garmintxt gpsclock greis isync itrax mtk3301 nmea ntrip navcom oceanserver oldstyle oncore rtcm104v2 rtcm104v3 sirf skytraq superstar2 timing tsip tripmate tnt ublox ubx" INPUT_DEVICES="libinput" KERNEL="linux" L10N="de en" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" LIBREOFFICE_EXTENSIONS="presenter-console presenter-minimizer" LUA_SINGLE_TARGET="lua5-1" LUA_TARGETS="lua5-1" OFFICE_IMPLEMENTATION="libreoffice" PHP_TARGETS="php7-4 php8-0" POSTGRES_TARGETS="postgres12 postgres13" PYTHON_SINGLE_TARGET="python3_9" PYTHON_TARGETS="python3_9" RUBY_TARGETS="ruby26 ruby27" USERLAND="GNU" VIDEO_CARDS="amdgpu fbdev intel nouveau radeon radeonsi vesa dummy v4l" XTABLES_ADDONS="quota2 psd pknock lscan length2 ipv4options ipset ipp2p iface geoip fuzzy condition tee tarpit sysrq proto steal rawnat logmark ipmark dhcpmac delude chaos account"
Unset:  ADDR2LINE, AR, ARFLAGS, AS, ASFLAGS, CC, CCLD, CONFIG_SHELL, CPP, CPPFLAGS, CTARGET, CXX, CXXFILT, ELFEDIT, EXTRA_ECONF, F77FLAGS, FC, GCOV, GPROF, INSTALL_MASK, LC_ALL, LD, LEX, LFLAGS, LIBTOOL, LINGUAS, MAKE, MAKEFLAGS, NM, OBJCOPY, OBJDUMP, PORTAGE_BUNZIP2_COMMAND, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS, PORTAGE_RSYNC_EXTRA_OPTS, RANLIB, READELF, RUSTFLAGS, SIZE, STRINGS, STRIP, YACC, YFLAGS




Comment 4


onkobu





          2022-03-28 20:15:15 UTC
        

I don't know what the build log could be usable for, will take some time to repeat the build (runs in tmpfs). All other functions work fine, incl. TLS and password authentication. Didn't change the USE:

[ Legend : U - final flag setting for installation]
[        : I - package is installed with flag     ]
[ Colors : set, unset                             ]
 * Found these USE flags for app-misc/mosquitto-2.0.14:
 U I
 - - bridge      : Enable bridge support in the MQTT broker. 
 - - examples    : Install examples, usually source code
 + + persistence : Store messages and subscriptions to a file. 
 + + srv         : Include SRV lookup support. 
 + + ssl         : Add support for SSL/TLS connections (Secure Socket Layer /
                   Transport Layer Security)
 - - tcpd        : Add support for TCP wrappers
 - - test        : Enable dependencies and/or preparations necessary to run
                   tests (usually controlled by FEATURES=test but can be
                   toggled independently)
 - - websockets  : Support the WebSocket protocol.




Comment 5


onkobu





          2022-03-28 20:33:45 UTC
        

Created attachment 768087 [details]
build.log




Comment 6


onkobu





          2022-06-08 20:07:34 UTC
        

How does REAL_WITH_MEMORY_TRACKING find its way into src_compile in the ebuild of 2.0.14?

https://github.com/eclipse/mosquitto/blob/master/lib/memory_mosq.c

Also the man page states that memory_limit only works with memory tracking enabled. I assume this is not the case.

Append REAL_WITH_MEMORY_TRACKING to emake-line of _emake()? Introduce a (local) USE-variable?




Comment 7


Matt Turner






          2022-06-12 21:12:01 UTC
        

I see this in src/CMakeLists.txt:

> option(INC_MEMTRACK
> 	"Include memory tracking support?" ON)
> if (INC_MEMTRACK)
> 	add_definitions("-DWITH_MEMORY_TRACKING")
> endif (INC_MEMTRACK)

Looks like it is on by default.

In lib/memory_mosq.h:

> #if defined(WITH_MEMORY_TRACKING) && defined(WITH_BROKER)
> #  if defined(__APPLE__) || defined(__FreeBSD__) || defined(__GLIBC__)
> #    define REAL_WITH_MEMORY_TRACKING
> #  endif
> #endif

CMakeLists.txt contains:

> option(WITH_BROKER "Build broker?" ON)

and I see src/CMakeLists.txt contains:

> add_definitions (-DWITH_BROKER)

which looks unconditional.

Oh, but we're not using CMake so...




Comment 8


Matt Turner






          2022-06-12 21:14:42 UTC
        

config.mk contains:

> WITH_MEMORY_TRACKING:=yes
> ...
> ifeq ($(WITH_MEMORY_TRACKING),yes)
> 	ifneq ($(UNAME),SunOS)
> 		BROKER_CPPFLAGS:=$(BROKER_CPPFLAGS) -DWITH_MEMORY_TRACKING
> 	endif
> endif

so it looks enabled by default in the static-Make build system as well.




Comment 9


onkobu





          2022-06-13 19:49:00 UTC
        

I unpacked the archive from /var/portage/distfiles and compiled it without any options. Then I copied the configuration of my running instance to a temporary location and played a bit with the memory_limit:

* -1024 -> error because <0
* 1024 -> out of memory error
* 4096 -> out of memory error
* 40031 -> out of memory error
* 1048576 -> starts, works, receives and broadcasts messages

The same sequence running mosquitto as root from console. But when running it via init.d-scripts it acts strange. Whereas 1024 yields an out of memory error 4096 does not but the service seems defunct. Process is running but doesn't publish messages and does not write logs. With memory_limit of 40031 it seems the same.

Finally 1048576 (1024x1024) yields a useable mosquitto instance. I assume smaller values work, too. Somewhere below that it runs into difficulties and reports no errors but also does not work correctly.

I mark it as solved because a) I found a value that works and b) somewhere below this value it behaves strange and I don't want to know the answer.









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


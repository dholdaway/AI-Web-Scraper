Title: 319201 – mail-filter/popfile upgrade overwrites custom config changes
URL: https://bugs.gentoo.org/show_bug.cgi?id=319201

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 319201
mail-filter/popfile upgrade overwrites custom config changes
Last modified: 2010-05-11 04:41:21 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 319201 
      - mail-filter/popfile upgrade overwrites custom config changes


Summary:
mail-filter/popfile upgrade overwrites custom config changes
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

Current packages

  (show other bugs)



Hardware:

All
        Linux
      







Importance:
      
High
       minor
      


Assignee:

Gentoo Linux bug wranglers








URL:







Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2010-05-10 19:47 UTC by Jack





      Modified:
    
2010-05-11 04:41 UTC
      (History)
    




          CC List:
        

1 
          user
          
            (show)
          



Lyall









See Also:






Package list:







Runtime testing required:

---























      Attachments
    



Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


Jack





          2010-05-10 19:47:59 UTC
        

By default, popfile seems to try to keep it's database in / instead of the more logical /usr/share/popfile.  Based on adding /etc/init.d/popfile script suggested in forum posts 484493 and 703961, this is set by the POPFILE_USER var, set in /etc/conf.d/popfile, and read in /usr/share/popfile/POPFile/Configuration.pm.

The big problem is that every time popfile is updated, the new version overwrites the Configuration.pm file and the next time you reboot or otherwise restart popfile, it again uses files in / instead of /usr/share/popfile until you remember to reapply the edits.

I don't know if there is an easy (or reasonable at all) way to not overwrite Configuration.pm, but it might be more appropriate for the ebuild to incorporate the changes suggested in the two above referenced forum posts.

This would require the addition to the ebuild of /etc/conf.d/popfile and /etc/init.d/popfile, and an edit to Configuration.pm within the popfile distribution.  If there is any chance of this being accepted, I'll be glad to do what I can to prepare the necessary files.

I would label this as more serious than minor, except the only thing lost is history of the rating of any files filtered by popfile until you re-apply the config edits and restart popfile again.  No actual messages are lost - just potentially mis-filtered to the wrong bucket.

Reproducible: Always

Steps to Reproduce:
1. make configuration changes per above referenced forum posts
2. upgrade popfile
3. restart popfile

Actual Results:  
popfile creates new files in / instead of /usr/share/popfile

Expected Results:  
popfile should continue using files (db, configuration) in /usr/share/popfile




Comment 1


Jeroen Roovers (RETIRED)






          2010-05-10 23:54:39 UTC
        

Quoting make.conf(5):

       CONFIG_PROTECT = [space delimited list of files and/or directories]
              All  files  and/or  directories  that are defined here will have
              "config file protection" enabled for them. See the CONFIGURATION
              FILES section of emerge(1) for more information.




Comment 2


Lyall Pearce





          2010-05-11 04:41:21 UTC
        

(In reply to comment #1)

I would re-open this bug, if I could.

Whilst the CONFIG_PROTECT option in /etc/make.conf would do the job, I believe the solution should be addressed by the ebuild, it should update this to reflect the location of the Popfile config file (which, should be in /etc, not /usr/share/popfile)

Otherwise, new installers will not know of this dependency and have the problem when they upgrade.


In addition,  maybe a patch is in order for /usr/share/popfile/POPFile/Loader.pm at line 765 (or thereabouts)

Changing         

select(undef, undef, undef, 0.05) if !$nowait;

to

select(undef, undef, undef, 1) if !$nowait;

This lowers the CPU consumption of Popfile considerably whilst keeping it responsive. 0.05 sleep time is ridiculous for a mail fetching program.

Also, I think the Popfile database should go into /var/db/popfile, not /usr/share/popfile. Personally, I try to keep my /usr filesystem as 'read-only' as possible.










Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


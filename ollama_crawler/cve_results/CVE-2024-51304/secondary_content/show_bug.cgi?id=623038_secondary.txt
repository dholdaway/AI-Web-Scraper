Title: 623038 – media-libs/mesa-17.0.6 causes enlightenment-0.21.7(0.17) to crash
URL: https://bugs.gentoo.org/show_bug.cgi?id=623038

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 623038
media-libs/mesa-17.0.6 causes enlightenment-0.21.7(0.17) to crash
Last modified: 2017-07-23 11:19:37 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 623038 
      - media-libs/mesa-17.0.6 causes enlightenment-0.21.7(0.17) to crash


Summary:
media-libs/mesa-17.0.6 causes enlightenment-0.21.7(0.17) to crash
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

Current packages

  (show other bugs)



Hardware:

All
        Linux
      







Importance:
      
Normal
       critical
      


Assignee:

Gentoo X packagers








URL:







Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2017-06-29 18:22 UTC by MickKi





      Modified:
    
2017-07-23 11:19 UTC
      (History)
    




          CC List:
        

1 
          user
          
            (show)
          



jstein









See Also:






Package list:







Runtime testing required:

---























      Attachments
    




Backtrace

              (mesa-17.0.6_crash.txt,40.89 KB,
                text/plain)

            
2017-06-29 18:26 UTC,

            MickKi




Details





emerge --info for mesa

              (emerge_info_mesa.txt,6.91 KB,
                text/plain)

            
2017-06-29 18:29 UTC,

            MickKi




Details





Backtrace for mesa-17.1.3

              (mesa-17.1.3_crash.txt,42.37 KB,
                text/plain)

            
2017-06-29 22:10 UTC,

            MickKi




Details





View All

Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


MickKi





          2017-06-29 18:22:04 UTC
        

media-libs/mesa-17.0.6 causes enlightenment-0.21.7(0.17) to crash when hovering over tooltips on different Gtk and Qt application menus.

Reproducible: Sometimes

Steps to Reproduce:
1. Open either of LibreOffice, Qpdfviewer, Kmail, Kwrite (but it is easier to reproduce on LO).
2. Hover over the main menu moving the mouse around such that tooltips show up and then disappear.
3. Repeat until the desktop freezes (but save your work before you start).
Actual Results:  
After a few times moving the mouse over the application menu, while tooltips disappear/reappear, libdri will freeze the whole desktop.  There is no way of recovering the login session and unsaved work is lost.

This has been observed on two different systems running enlightenment, but the backtrace I captured shows this is a mesa problem affecting the compositor on radeon drivers.  One system is running AMD Kaveri APU, the other has ATI Mobility Radeon HD 4670.

Expected Results:  
libdri should not be causing the compositor to freeze.  WM/desktops which do not use compositor e.g. fluxbox do not suffer from this problem.  I have not tried other (non-evas) compositors.

Carsten Haitzler one of the enlightenment devs commented the backtrace indicates this is fence sync problem within the driver layer. "It's a problem between the driver and itself across process boundaries."

This are mesa's flags on the Radeon HD 4670 system:

# emerge -1aDv media-libs/mesa

These are the packages that would be merged, in order:

Calculating dependencies... done!
[ebuild   R    ] media-libs/mesa-17.0.6::gentoo  USE="classic dri3 egl gallium gbm gles2 llvm nptl vaapi vdpau wayland xvmc -bindist -d3d9 -debug -gles1 -opencl -openmax -osmesa -pax_kernel -pic (-selinux) -valgrind -vulkan -xa" ABI_X86="32 (64) (-x32)" VIDEO_CARDS="r600 radeon (-freedreno) -i915 -i965 -imx -intel -nouveau -r100 -r200 -r300 -radeonsi (-vc4) (-vivante) -vmware" 0 KiB

Please let me know if you need additional information.




Comment 1


MickKi





          2017-06-29 18:26:50 UTC
        

Created attachment 478350 [details]
Backtrace

Backtrace captured on system with Radeon HD 4670, when LO caused the crash.




Comment 2


MickKi





          2017-06-29 18:29:33 UTC
        

Created attachment 478352 [details]
emerge --info for mesa

emerge --info while debugging mesa.




Comment 3


Matt Turner






          2017-06-29 20:42:50 UTC
        

Does it occur with 17.1.x?




Comment 4


MickKi





          2017-06-29 22:08:54 UTC
        

Thanks Matt,

I'm afraid yes, it feels like the desktop crashes even easier/sooner than with mesa-17.0.6.  :-(

Backtrace for 17.1.3 on Radeon HD 4670 follows.
-- 
Kind regards,
Mick




Comment 5


MickKi





          2017-06-29 22:10:41 UTC
        

Created attachment 478432 [details]
Backtrace for mesa-17.1.3

Backtrace from mesa-17.1.3 generated with LOcalc.




Comment 6


MickKi





          2017-06-30 10:15:57 UTC
        

I have just replicated the dri crash on a PC with an Acer Incorporated [ALI] Mobile 4 Series Chipset Integrated Graphics Controller (ICH9 chipset).  So this seems to be a more generalised mesa problem, not Radeon specific.  Please let me know what additional information you may need.

Emerge --info for this Intel system shown below:
===============================================
 emerge --info mesa
Portage 2.3.6 (python 3.4.5-final-0, default/linux/amd64/13.0/no-multilib, gcc-5.4.0, glibc-2.23-r4, 4.9.34-gentoo x86_64)
=================================================================
                         System Settings
=================================================================
System uname: Linux-4.9.34-gentoo-x86_64-Intel-R-_Core-TM-2_Duo_CPU_P7550_@_2.26GHz-with-gentoo-2.3
KiB Mem:     3969696 total,   2207952 free
KiB Swap:    3145724 total,   3145724 free
Timestamp of repository gentoo: Fri, 30 Jun 2017 09:15:01 +0000
sh bash 4.3_p48-r1
ld GNU ld (Gentoo 2.28 p1.2) 2.28
app-shells/bash:          4.3_p48-r1::gentoo
dev-lang/perl:            5.24.1-r2::gentoo
dev-lang/python:          2.7.12::gentoo, 3.4.5::gentoo
dev-util/cmake:           3.7.2::gentoo
dev-util/pkgconfig:       0.28-r2::gentoo
sys-apps/baselayout:      2.3::gentoo
sys-apps/openrc:          0.26.3::gentoo
sys-apps/sandbox:         2.10-r3::gentoo
sys-devel/autoconf:       2.13::gentoo, 2.69::gentoo
sys-devel/automake:       1.15-r2::gentoo
sys-devel/binutils:       2.28-r2::gentoo
sys-devel/gcc:            5.4.0-r3::gentoo
sys-devel/gcc-config:     1.7.3::gentoo
sys-devel/libtool:        2.4.6-r3::gentoo
sys-devel/make:           4.2.1::gentoo
sys-kernel/linux-headers: 4.4::gentoo (virtual/os-headers)
sys-libs/glibc:           2.23-r4::gentoo
Repositories:

gentoo
    location: /usr/portage
    sync-type: rsync
    sync-uri: rsync://rsync.uk.gentoo.org/gentoo-portage
    priority: -1000

miramir
    location: /var/lib/layman/miramir
    masters: gentoo
    priority: 50

local
    location: /usr/local/portage
    masters: gentoo
    priority: 100

ACCEPT_KEYWORDS="amd64"
ACCEPT_LICENSE="* -@EULA AdobeFlash-11.x RAR"
CBUILD="x86_64-pc-linux-gnu"
CFLAGS="-march=native -O2 -pipe"
CHOST="x86_64-pc-linux-gnu"
CONFIG_PROTECT="/etc /usr/share/config /usr/share/gnupg/qualified.txt"
CONFIG_PROTECT_MASK="/etc/ca-certificates.conf /etc/dconf /etc/env.d /etc/fonts/fonts.conf /etc/gconf /etc/gentoo-release /etc/revdep-rebuild /etc/sandbox.d /etc/terminfo"
CXXFLAGS="-march=native -O2 -pipe"
DISTDIR="/usr/portage/distfiles"
FCFLAGS="-O2 -pipe"
FEATURES="assume-digests binpkg-logs config-protect-if-modified distlocks ebuild-locks fail-clean fixlafiles merge-sync news parallel-fetch preserve-libs protect-owned sandbox sfperms strict unknown-features-warn unmerge-logs unmerge-orphans userfetch userpriv usersandbox usersync xattr"
FFLAGS="-O2 -pipe"
GENTOO_MIRRORS="http://mirror.qubenet.net/mirror/gentoo/ rsync://rsync.mirrorservice.org/distfiles.gentoo.org/ http://ftp.snt.utwente.nl/pub/os/linux/gentoo ftp://ftp.snt.utwente.nl/pub/os/linux/gentoo http://www.mirrorservice.org/sites/distfiles.gentoo.org/"
LANG="en_GB.UTF8"
LDFLAGS="-Wl,-O1 -Wl,--as-needed"
MAKEOPTS="-j3"
PKGDIR="/usr/portage/packages"
PORTAGE_CONFIGROOT="/"
PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --omit-dir-times --compress --force --whole-file --delete --stats --human-readable --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages --exclude=/.git"
PORTAGE_TMPDIR="/var/tmp"
USE="X acl alsa amd64 berkdb bzip2 cdr cli connman consolekit cracklib crypt cxx dbus dri dvd exif fam ffmpeg fortran gdbm glamor gpm iconv icu ipv6 lm_sensors lzma mmx modules ncurses nls nptl opengl openmp pam pcre png policykit qt5 readline seccomp semantic-desktop session sse sse2 sse3 sse4_1 ssl ssse3 svg tcpd udev udisks unicode upower vaapi webp xattr zlib" ABI_X86="64" ALSA_CARDS="ali5451 als4000 atiixp atiixp-modem bt87x ca0106 cmipci emu10k1x ens1370 ens1371 es1938 es1968 fm801 hda-intel intel8x0 intel8x0m maestro3 trident usb-audio via82xx via82xx-modem ymfpci" APACHE2_MODULES="authn_core authz_core socache_shmcb unixd actions alias auth_basic authn_alias authn_anon authn_dbm authn_default authn_file authz_dbm authz_default authz_groupfile authz_host authz_owner authz_user autoindex cache cgi cgid dav dav_fs dav_lock deflate dir disk_cache env expires ext_filter file_cache filter headers include info log_config logio mem_cache mime mime_magic negotiation rewrite setenvif speling status unique_id userdir usertrack vhost_alias" CALLIGRA_FEATURES="kexi words flow plan sheets stage tables krita karbon braindump author" COLLECTD_PLUGINS="df interface irq load memory rrdtool swap syslog" CPU_FLAGS_X86="mmx mmxext sse sse2 sse3 sse4_1 ssse3" ELIBC="glibc" GPSD_PROTOCOLS="ashtech aivdm earthmate evermore fv18 garmin garmintxt gpsclock isync itrax mtk3301 nmea ntrip navcom oceanserver oldstyle oncore rtcm104v2 rtcm104v3 sirf skytraq superstar2 timing tsip tripmate tnt ublox ubx" INPUT_DEVICES="evdev synaptics" KERNEL="linux" L10N="en-GB" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" LIBREOFFICE_EXTENSIONS="presenter-console presenter-minimizer" LINGUAS="en_GB" OFFICE_IMPLEMENTATION="libreoffice" PHP_TARGETS="php5-6" PYTHON_SINGLE_TARGET="python3_4" PYTHON_TARGETS="python2_7 python3_4" RUBY_TARGETS="ruby21 ruby22" USERLAND="GNU" VIDEO_CARDS="intel i965" XTABLES_ADDONS="quota2 psd pknock lscan length2 ipv4options ipset ipp2p iface geoip fuzzy condition tee tarpit sysrq steal rawnat logmark ipmark dhcpmac delude chaos account"
Unset:  CC, CPPFLAGS, CTARGET, CXX, EMERGE_DEFAULT_OPTS, INSTALL_MASK, LC_ALL, PORTAGE_BUNZIP2_COMMAND, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS, PORTAGE_RSYNC_EXTRA_OPTS, USE_PYTHON

=================================================================
                        Package Settings
=================================================================

media-libs/mesa-17.0.6::gentoo was built with the following:
USE="classic dri3 egl gallium gbm llvm nptl vaapi -bindist -d3d9 -debug -gles1 -gles2 -opencl -openmax -osmesa -pax_kernel -pic (-selinux) -valgrind -vdpau -vulkan -wayland -xa -xvmc" VIDEO_CARDS="i965 intel (-freedreno) -i915 -imx -nouveau -r100 -r200 -r300 -r600 -radeon -radeonsi (-vc4) (-vivante) -vmware"
==============================================
-- 
Kind regards,
Mick




Comment 7


MickKi





          2017-07-07 09:36:02 UTC
        

I've rebuilt dev-libs/efl and x11-wm/enlightenment from trunk using the bar overlay and the same crash happens.
-- 
Regards,
Mick




Comment 8


MickKi





          2017-07-08 16:05:32 UTC
        

Unfortunately the dri bug is still there with the media-libs/mesa-17.1.4 release.
-- 
Kind regards,
Mick




Comment 9


MickKi





          2017-07-23 11:19:37 UTC
        

The bug seems to have gone away after some change in my USE flags.  These are the relevant package builds which work without crashing at present:

dev-libs/efl-1.18.4::gentoo was built with the following:
USE="X bmp eet egl fontconfig gif gles ico nls physics png ppm psd pulseaudio sound ssl tiff wayland webp -debug -doc -drm -fbcon -fribidi -glib -gnutls -gstreamer -harfbuzz -ibus -jpeg2k -libressl (-neon) -oldlua -opengl (-pixman) -postscript -raw -scim -sdl -systemd -tga -tslib -unwind -v4l -valgrind -xim -xine -xpm" ABI_X86="(64)"

x11-wm/enlightenment-0.21.7::gentoo was built with the following:
USE="nls pam spell ukit wayland -doc -static-libs -systemd" ABI_X86="(64)" ENLIGHTENMENT_MODULES="appmenu backlight battery bluez4 clock conf conf-applications conf-bindings conf-dialogs conf-display conf-interaction conf-intl conf-menus conf-paths conf-performance conf-randr conf-shelves conf-theme conf-window-manipulation conf-window-remembers connman cpufreq everything fileman fileman-opinfo gadman geolocation ibar ibox lokker mixer msgbus music-control notification packagekit pager pager-plain policy-mobile quickaccess shot start syscon systray tasks teamwork temperature tiling time winlist wireless wizard wl-desktop-shell wl-drm wl-text-input wl-weekeyboard wl-wl wl-x11 xkbswitch xwayland"

media-libs/mesa-17.0.6::gentoo was built with the following:
USE="classic dri3 egl gallium gbm gles2 llvm nptl vaapi vdpau wayland xvmc -bindist -d3d9 -debug -gles1 -opencl -openmax -osmesa -pax_kernel -pic (-selinux) -valgrind -vulkan -xa" ABI_X86="32 (64) (-x32)" VIDEO_CARDS="r600 radeon (-freedreno) -i915 -i965 -imx -intel -nouveau -r100 -r200 -r300 -radeonsi (-vc4) (-vivante) -vmware"


I disabled the OpenGL USE flag and arrived at the above combo when I tried to get wayland working.  So for now I'm closing this bug since it no longer occurs on my systems, but if the backtrace posted reveals something which needs reporting upstream/fixing please re-open as you see fit.
-- 
Kind regards,
Mick









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


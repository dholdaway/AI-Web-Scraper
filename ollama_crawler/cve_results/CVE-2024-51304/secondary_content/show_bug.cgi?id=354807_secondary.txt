Title: 354807 – mount-boot.eclass: /proc/mounts parsing does not work well inside of chroots
URL: https://bugs.gentoo.org/show_bug.cgi?id=354807

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 354807
mount-boot.eclass: /proc/mounts parsing does not work well inside of chroots
Last modified: 2015-07-30 07:26:29 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 354807 
      - mount-boot.eclass: /proc/mounts parsing does not work well inside of chroots


Summary:
mount-boot.eclass: /proc/mounts parsing does not work well inside of chroots
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

Eclasses

  (show other bugs)



Hardware:

All
        Linux
      







Importance:
      
High
       normal
      


Assignee:

Gentoo's Team for Core System packages








URL:







Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2011-02-14 05:13 UTC by Daniel Robbins





      Modified:
    
2015-07-30 07:26 UTC
      (History)
    




          CC List:
        

1 
          user
          
            (show)
          



staff









See Also:






Package list:







Runtime testing required:

---























      Attachments
    




patch to fix mount-boot.eclass behavior for new installs

              (mount-boot.eclass.patch,2.82 KB,
                patch)

            
2011-02-14 05:16 UTC,

            Daniel Robbins




Details
            | Diff





View All

Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


Daniel Robbins





          2011-02-14 05:13:28 UTC
        

The recent (~Jan 8 2011) updates to mount-boot.eclass often break installs. The symptoms are that /boot in the chroot is remounted as read-only after an ebuild that uses boot-mount.eclass is run. In Funtoo, this breaks GRUB2 installs because the device.map cannot be written to /boot/grub.

I have spent a lot of time debugging this, and determined the problem is caused because boot-mount.eclass uses /proc/mounts to get mount information. Unlike the "mount" command, /proc/mounts does not adjust mount points to be relative to the chroot path. So things will get weird because /boot will really be mounted at /mnt/gentoo/boot, instead of /boot, and in addition, the sysrescuecd and possibly the gentoo install cd has things mounted at /foo/bar/boot (can't remember the actual path, but they have things ending in /boot that aren't /mnt/gentoo/boot.)

This makes it very difficult to work around this with /proc/mounts output. The solution I implemented is to use "mount" output which tries to normalize the mount-point in the output. I am attaching a patch which fixes mount-boot.eclass and adds some comments to make it easier to understand what it is doing. The new approach of handling "ro" mounts is left mostly intact, so that functionality remains - except now it should work in chroots as well as on already-installed systems.

I have tested this code and it appears to work well. I have tested:

1. existing system - /boot unmounted
2. existing system - /boot mounted rw
3. existing system - /boot mounted ro
4. existing system - /boot unmounted with "ro" option in /etc/fstab
5. new install in chroot - /boot mounted

For all these tests, everything behaved as expected.

Regards,

Daniel




Comment 1


Daniel Robbins





          2011-02-14 05:16:22 UTC
        

Created attachment 262407 [details, diff]
patch to fix mount-boot.eclass behavior for new installs




Comment 2


Daniel Robbins





          2011-02-14 05:18:56 UTC
        

Also note - I forgot that I did disable prerm and postrm mount/unmount
functionality in mount-boot.eclass, and this is reflected in the patch. This is
not absolutely necessary and you can keep this functionality by just excluding
that portion of the patch -- export_functions and the prerm/postrm functions
themselves.




Comment 3


SpanKY






          2011-02-17 06:10:55 UTC
        

yes, we want to keep pkg_prerm support.  otherwise how is `emerge -C` supposed to work ?

i also prefer to keep the log about /boot assumption.

you call `mount` more than once ... keep the output in a single var.




Comment 4


Daniel Robbins





          2011-02-17 06:17:11 UTC
        

Change whatever you want.




Comment 5


SpanKY






          2015-07-30 07:23:31 UTC
        

i can't reproduce the behavior you describe.  it could be due to the kernel changing the output of /proc/mounts relative to the chroot or some other setting i have active ...

first:
- create a chroot and bind mount /boot to $chroot/boot
- enter the chroot
- observe /proc/mounts shows /boot

second:
- create a chroot and unmount /boot
- enter the chroot
- mount /boot
- observe /proc/mounts shows /boot









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


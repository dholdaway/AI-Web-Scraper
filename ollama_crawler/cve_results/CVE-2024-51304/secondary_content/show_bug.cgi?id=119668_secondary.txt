Title: 119668 – [glibc/locale] locales are screwed up in glibc-2.3.5-r2
URL: https://bugs.gentoo.org/show_bug.cgi?id=119668

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 119668
[glibc/locale] locales are screwed up in glibc-2.3.5-r2
Last modified: 2006-07-01 00:48:15 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 119668 
      - [glibc/locale] locales are screwed up in glibc-2.3.5-r2


Summary:
[glibc/locale] locales are screwed up in glibc-2.3.5-r2
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

[OLD] Core system

  (show other bugs)



Hardware:

x86
        Linux
      







Importance:
      
High
       critical
      


Assignee:

Gentoo Toolchain Maintainers








URL:







Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2006-01-20 03:33 UTC by mikael lammentausta





      Modified:
    
2006-07-01 00:48 UTC
      (History)
    




          CC List:
        

1 
          user
          
            (show)
          



spamwhole









See Also:






Package list:







Runtime testing required:

---























      Attachments
    



Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


mikael lammentausta





          2006-01-20 03:33:11 UTC
        

This problem occured to me on the old system, I believe after I recompiled glibc with some unsafe flags (erandom and omitfp). 

When I start Gimp, it says:
GLib: Cannot convert message: Cannot convert fallback '?' to codeset 'ISO-8859-15' 
Several programs throw glib errors (I don't have specifics here, sorry)
vim gives plentiful or "no previous regular expression" errors.

So I installed the system from scratch. 

Steps:

1. Boot up the livecd 2005.1-r1
2. Partition the disk
3. untar stage3 and portage tarballs
4. cp old system conf files to /etc and the kernel .config, namely make.conf, locales.build, localtime, portage/package.* and some files to conf.d and env.d
5. chroot to the new system
6. quickpkg glibc
7. emerge gcc ; gcc-config 6 # switching to new gcc
8. emerge glibc -va

[ebuild     U ] sys-libs/glibc-2.3.5-r2 [2.3.4.20041102-r1] -build -erandom -glibc-compat20 -glibc-omitfp -hardened -linuxthreads-tls (-multilib) +nls -nptl -nptlonly -pic -profile (-selinux) +userlocales* 0 kB

9. emerge vim
10. vim  #vim then throws a number of errors
11. emerge =glibc-2.3.4.20041102-r1 -k # installing the old binary glibc 
12. vim  #vim works

Probably several other packages also give errors. The only flag I used for new glibc is the +userlocales. Here's my /etc/locales.build:

en_GB/ISO-8859-1
en_GB.UTF-8/UTF-8
en_US/ISO-8859-1
en_US.UTF-8/UTF-8
fi_FI/ISO-8859-1
fi_FI@euro/ISO-8859-15
fi_FI.UTF-8/UTF-8

I also compiled the kernel with the necessary codepages and rebooted, the problem persists. Also the livecd kernel probably has all of these.

My system does not use unicode.

I also tried to compile the new glibc with the gcc that comes on the livecd. Same problem.

Previously I've been able to use glibc-2.3.5-r2 without problems with these safe flags, and also on several other computers. Why not on this one, I can't tell. That's why I'm filing this bug report. The only open loop on this system is my package.use and package.keywords, but I don't use any unstable system packages. Everything else is just the livecd stuff. I also use safe CFLAGS like you can see below.




Comment 1


mikael lammentausta





          2006-01-20 03:33:34 UTC
        

Portage 2.0.53 (default-linux/x86/2005.1, gcc-3.4.4, glibc-2.3.4.20041102-r1, 2.6.14-gentoo-r5 i686)
=================================================================
System uname: 2.6.14-gentoo-r5 i686 Intel(R) Pentium(R) 4 CPU 2.80GHz
Gentoo Base System version 1.6.13
distcc 2.18.3 i686-pc-linux-gnu (protocols 1 and 2) (default port 3632) [enabled]
dev-lang/python:     2.3.5-r2, 2.4.2
sys-apps/sandbox:    1.2.11
sys-devel/autoconf:  2.13, 2.59-r6
sys-devel/automake:  1.4_p6, 1.5, 1.6.3, 1.7.9-r1, 1.8.5-r3, 1.9.5
sys-devel/binutils:  2.16.1
sys-devel/libtool:   1.5.22
virtual/os-headers:  2.6.11-r2
ACCEPT_KEYWORDS="x86"
AUTOCLEAN="yes"
CBUILD="i686-pc-linux-gnu"
CFLAGS="-O2 -march=pentium4 -pipe -fomit-frame-pointer"
CHOST="i686-pc-linux-gnu"
CONFIG_PROTECT="/etc /usr/kde/2/share/config /usr/kde/3.5/env /usr/kde/3.5/share/config /usr/kde/3.5/shutdown /usr/kde/3/share/config /usr/lib/X11/xkb /usr/share/config /var/qmail/control"
CONFIG_PROTECT_MASK="/etc/gconf /etc/terminfo /etc/env.d"
CXXFLAGS="-O2 -march=pentium4 -pipe -fomit-frame-pointer"
DISTDIR="/var/distfiles"
FEATURES="autoconfig distcc distlocks sandbox sfperms strict"
GENTOO_MIRRORS="ftp://trumpetti.atm.tut.fi/gentoo"
LINGUAS="fi en"
MAKEOPTS="-j4"
PKGDIR="/mnt/quickpkg"
PORTAGE_TMPDIR="/var/tmp"
PORTDIR="/usr/portage"
PORTDIR_OVERLAY="/usr/local/portage/gentoo-de /usr/local/portage/mikael"
SYNC="rsync://rsync.gentoo.org/gentoo-portage"
USE="x86 X aalib acpi alsa arts asm audiofile avi berkdb bitmap-fonts bzip2 bzlib cdr crypt css cups curl directfb divx4linux dts dvb dvd dvdr emboss encode exif expat fam fbcon ffmpeg firefox flac font-server foomaticdb fortran gd gdbm gif glut gmp gpm gstreamer gtk gtk2 gtkhtml hal idn imagemagick imlib imlib2 jack jikes jpeg kde kdeenablefinal kdexdeltas lcms libcaca libg++ libwww mad matroska mikmod mmx mng motif mp3 mpeg mysql nas ncurses nls nptl ogg oggvorbis opengl pam pcre pdflib perl png python qt readline sdl slang slp spell sqlite sse sse2 ssl tcltk tcpd theora tiff truetype truetype-fonts type1-fonts udev usb v4l v4l2 vdr vidix vorbis win32codecs wmf xine xinerama xml2 xmms xv xvid xvmc zlib video_cards_radeon linguas_fi linguas_en userland_GNU kernel_linux elibc_glibc"
Unset:  ASFLAGS, CTARGET, LANG, LC_ALL, LDFLAGS






Comment 2


Jakub Moc (RETIRED)






          2006-01-20 04:05:09 UTC
        

Reopen with output of 'locale' and 'locale -a'




Comment 3


mikael lammentausta





          2006-01-20 04:35:13 UTC
        

locale

LANG=
LC_CTYPE=fi_FI@euro
LC_NUMERIC=fi_FI@euro
LC_TIME=fi_FI@euro
LC_COLLATE=fi_FI@euro
LC_MONETARY=fi_FI@euro
LC_MESSAGES="POSIX"
LC_PAPER=fi_FI@euro
LC_NAME="POSIX"
LC_ADDRESS="POSIX"
LC_TELEPHONE="POSIX"
LC_MEASUREMENT="POSIX"
LC_IDENTIFICATION="POSIX"
LC_ALL=



locale -a

aa_DJ
aa_ER
aa_ER@saaho
aa_ET
af_ZA
am_ET
an_ES
ar_AE
ar_AE.utf8
ar_BH
ar_BH.utf8
ar_DZ
ar_DZ.utf8
ar_EG
ar_EG.utf8
ar_IN
ar_IQ
ar_IQ.utf8
ar_JO
ar_JO.utf8
ar_KW
ar_KW.utf8
ar_LB
ar_LB.utf8
ar_LY
ar_LY.utf8
ar_MA
ar_MA.utf8
ar_OM
ar_OM.utf8
ar_QA
ar_QA.utf8
ar_SA
ar_SA.utf8
ar_SD
ar_SD.utf8
ar_SY
ar_SY.utf8
ar_TN
ar_TN.utf8
ar_YE
ar_YE.utf8
az_AZ.utf8
be_BY
be_BY.utf8
bg_BG
bg_BG.utf8
bn_BD
bn_IN
br_FR
br_FR@euro
bs_BA
byn_ER
C
ca_ES
ca_ES@euro
ca_ES.utf8
cs_CZ
cs_CZ.utf8
cy_GB
cy_GB.utf8
da_DK
da_DK.iso885915
da_DK.utf8
de_AT
de_AT@euro
de_AT.utf8
de_BE
de_BE@euro
de_BE.utf8
de_CH
de_CH.utf8
de_DE
de_DE@euro
de_DE.utf8
de_LU
de_LU@euro
de_LU.utf8
el_GR
el_GR.utf8
en_AU
en_AU.utf8
en_BW
en_BW.utf8
en_CA
en_CA.utf8
en_DK
en_DK.utf8
en_GB
en_GB.iso885915
en_GB.utf8
en_HK
en_HK.utf8
en_IE
en_IE@euro
en_IE.utf8
en_IN
en_NZ
en_NZ.utf8
en_PH
en_PH.utf8
en_SG
en_SG.utf8
en_US
en_US.iso885915
en_US.utf8
en_ZA
en_ZA.utf8
en_ZW
en_ZW.utf8
es_AR
es_AR.utf8
es_BO
es_BO.utf8
es_CL
es_CL.utf8
es_CO
es_CO.utf8
es_CR
es_CR.utf8
es_DO
es_DO.utf8
es_EC
es_EC.utf8
es_ES
es_ES@euro
es_ES.utf8
es_GT
es_GT.utf8
es_HN
es_HN.utf8
es_MX
es_MX.utf8
es_NI
es_NI.utf8
es_PA
es_PA.utf8
es_PE
es_PE.utf8
es_PR
es_PR.utf8
es_PY
es_PY.utf8
es_SV
es_SV.utf8
es_US
es_US.utf8
es_UY
es_UY.utf8
es_VE
es_VE.utf8
et_EE
et_EE.iso885915
et_EE.utf8
eu_ES
eu_ES@euro
eu_ES.utf8
fa_IR
fi_FI
fi_FI@euro
fi_FI.utf8
fo_FO
fo_FO.utf8
fr_BE
fr_BE@euro
fr_BE.utf8
fr_CA
fr_CA.utf8
fr_CH
fr_CH.utf8
fr_FR
fr_FR@euro
fr_FR.utf8
fr_LU
fr_LU@euro
fr_LU.utf8
ga_IE
ga_IE@euro
ga_IE.utf8
gd_GB
gez_ER
gez_ER@abegede
gez_ET
gez_ET@abegede
gl_ES
gl_ES@euro
gl_ES.utf8
gu_IN
gv_GB
gv_GB.utf8
he_IL
he_IL.utf8
hi_IN
hr_HR
hr_HR.utf8
hu_HU
hu_HU.utf8
id_ID
id_ID.utf8
is_IS
is_IS.utf8
it_CH
it_CH.utf8
it_IT
it_IT@euro
it_IT.utf8
iw_IL
iw_IL.utf8
ja_JP.eucjp
ja_JP.utf8
ka_GE
kk_KZ
kl_GL
kl_GL.utf8
kn_IN
ko_KR.euckr
ko_KR.utf8
kw_GB
kw_GB.utf8
lg_UG
lo_LA
lt_LT
lt_LT.utf8
lv_LV
lv_LV.utf8
mi_NZ
mk_MK
mk_MK.utf8
ml_IN
mn_MN
mr_IN
ms_MY
ms_MY.utf8
mt_MT
mt_MT.utf8
nb_NO
nb_NO.utf8
ne_NP
nl_BE
nl_BE@euro
nl_BE.utf8
nl_NL
nl_NL@euro
nl_NL.utf8
nn_NO
nn_NO.utf8
no_NO
no_NO.utf8
oc_FR
om_ET
om_KE
pa_IN
pl_PL
pl_PL.utf8
POSIX
pt_BR
pt_BR.utf8
pt_PT
pt_PT@euro
pt_PT.utf8
ro_RO
ro_RO.utf8
ru_RU
ru_RU.koi8r
ru_RU.utf8
ru_UA
ru_UA.utf8
se_NO
sid_ET
sk_SK
sk_SK.utf8
sl_SI
sl_SI.utf8
so_DJ
so_ET
so_KE
so_SO
sq_AL
sq_AL.utf8
st_ZA
st_ZA.utf8
sv_FI
sv_FI@euro
sv_FI.utf8
sv_SE
sv_SE.iso885915
sv_SE.utf8
ta_IN
te_IN
tg_TJ
th_TH
th_TH.utf8
ti_ER
ti_ET
tig_ER
tl_PH
tr_TR
tr_TR.utf8
tt_RU.utf8
uk_UA
uk_UA.utf8
ur_PK
uz_UZ
uz_UZ@cyrillic
vi_VN
vi_VN.tcvn
wa_BE
wa_BE@euro
wa_BE.utf8
xh_ZA
xh_ZA.utf8
yi_US
zh_CN
zh_CN.gbk
zh_CN.gb18030
zh_CN.utf8
zh_HK
zh_HK.utf8
zh_SG
zh_SG.gbk
zh_TW
zh_TW.euctw
zh_TW.utf8
zu_ZA
zu_ZA.utf8





Comment 4


mikael lammentausta





          2006-01-20 05:12:22 UTC
        

The _above_ locales are for the *working* glibc, that came on the livecd.

I recompiler the *same* version with +userlocales, it has the same problem than the newer one.

Here are the locales for the *broken* glibc.

locale

LANG=
LC_CTYPE=fi_FI@euro
LC_NUMERIC=fi_FI@euro
LC_TIME=fi_FI@euro
LC_COLLATE=fi_FI@euro
LC_MONETARY=fi_FI@euro
LC_MESSAGES="POSIX"
LC_PAPER=fi_FI@euro
LC_NAME="POSIX"
LC_ADDRESS="POSIX"
LC_TELEPHONE="POSIX"
LC_MEASUREMENT="POSIX"
LC_IDENTIFICATION="POSIX"
LC_ALL=


locale -a

C
en_GB
en_GB.utf8
en_US
en_US.utf8
fi_FI
fi_FI@euro
fi_FI.utf8
POSIX





Comment 5


mikael lammentausta





          2006-01-20 06:51:49 UTC
        

I've recompiled glibc with USE="-userlocales" CFLAGS="" and still the same problem persists. Gcc-3.4.4-r1. Could this a bug in glibc, gcc, glib, or somewhere else?

For reference, my essential system packages:

[I] dev-libs/glib (1.2.10-r5 2.8.4): The GLib library of C routines
[I] sys-libs/glibc (2.3.4.20041102-r1): GNU libc6 (also called glibc2) C library
[I] sys-devel/gcc (3.3.5.20050130-r1 3.4.4-r1): The GNU Compiler Collection. 
[I] sys-devel/libtool (1.5.22): A shared library tool for developers
[I] sys-devel/make (3.80-r1): Standard tool to compile source trees
[I] sys-devel/binutils (2.16.1): Tools necessary to build programs
[I] sys-devel/automake (1.4_p6 1.5 1.6.3 1.7.9-r1 1.8.5-r3 1.9.5): Used to generate Makefile.in from Makefile.am
[I] sys-libs/lib-compat (1.4): Compatibility C++ and libc5 and libc6 libraries for programs new and old





Comment 6


mikael lammentausta





          2006-01-20 07:02:31 UTC
        

This is what vim reports:

Error detected while processing /etc/vim/vimrc:
line    2:
E35: No previous regular expression
line    4:
E35: No previous regular expression
line    5:
E35: No previous regular expression
.....


gimp:

Lib: Cannot convert message: Cannot convert fallback '?' to codeset 'ISO-8859-15'

(gimp:7863): LibGimpBase-CRITICAL **: gimp_datafiles_read_directories: assertion `path_str != NULL' failed

(gimp:7863): LibGimpBase-CRITICAL **: gimp_datafiles_read_directories: assertion `path_str != NULL' failed

(gimp:7863): LibGimpBase-CRITICAL **: gimp_datafiles_read_directories: assertion `path_str != NULL' failed

(gimp:7863): LibGimpBase-CRITICAL **: gimp_datafiles_read_directories: assertion `path_str != NULL' failed

(gimp:7863): LibGimpBase-CRITICAL **: gimp_datafiles_read_directories: assertion `path_str != NULL' failed

(gimp:7863): LibGimpBase-CRITICAL **: gimp_datafiles_read_directories: assertion `path_str != NULL' failed

(gimp:7863): Gimp-Text-CRITICAL **: gimp_fonts_add_directories: assertion `path_str != NULL' failed

(gimp:7863): LibGimpModule-CRITICAL **: gimp_module_db_load: assertion `module_path != NULL' failed

(gimp:7863): LibGimpBase-CRITICAL **: gimp_datafiles_read_directories: assertion `path_str != NULL' failed

(gimp:7863): GLib-CRITICAL **: g_path_is_absolute: assertion `file_name != NULL' failed


gqview:
GQview 2.1.1, This is a beta release.
Unable to convert filename to locale from UTF-8:


And so on... many applications do not function properly, but after I switch back to the binary glibc that came on the livecd, they work again. 




Comment 7


SpanKY






          2006-07-01 00:48:15 UTC
        

glibc-2.3.6-r4+ should have this resolved









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


Title: 167478 – wpa_supplicant doesn't start with net.eth1 init script but start with a simpler manual script
URL: https://bugs.gentoo.org/show_bug.cgi?id=167478

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 167478
wpa_supplicant doesn't start with net.eth1 init script but start with a simpler manual script
Last modified: 2007-04-19 06:59:55 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 167478 
      - wpa_supplicant doesn't start with net.eth1 init script but start with a simpler manual script


Summary:
wpa_supplicant doesn't start with net.eth1 init script but start with a simpl...
        









Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

[OLD] baselayout

  (show other bugs)



Hardware:

PPC
        Linux
      







Importance:
      
High
       major
      


Assignee:

Gentoo's Team for Core System packages








URL:



http://forums.gentoo.org/viewtopic-p-...
        




Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2007-02-18 13:56 UTC by mambro





      Modified:
    
2007-04-19 06:59 UTC
      (History)
    




          CC List:
        

0 
          users
        








See Also:






Package list:







Runtime testing required:

---























      Attachments
    



Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


mambro





          2007-02-18 13:56:36 UTC
        

I've an ibook g4 with airport extreme wireless card. I use bcm43xx module from the  kernel.

My /etc/conf.d/net is like that
config_eth1=( "192.168.1.4" )
routes_eth1=( "default via 192.168.1.1" )

modules=( "wpa_supplicant" )
wpa_supplicant_eth1="-Dwext"
associate_timeout_eth1=60

If i do /etc/init.d/net.eth1 start it do this
ibook mambro # /etc/init.d/net.eth1 start
 * Starting eth1
 *   Starting wpa_supplicant on eth1 ...                                  [ ok ]
 *   Starting wpa_cli on eth1 ...                                         [ ok ]
 *     eth1 connected to "*********" at 00:18:**:**:**:**
 *   eth1 configured with address 192.168.1.4/32
(i've hiden some personal information)

But if i try the network doesn't work
ibook mambro # ping 192.168.1.1
connect: Network is unreachable

I've made this script:
ibook mambro # cat connectWiFi 
/etc/init.d/net.eth1 stop
killall wpa_supplicant
killall wpa_cli
modprobe -r bcm43xx
modprobe bcm43xx
ifconfig eth1 192.168.1.4 up
wpa_supplicant -Dwext -c/etc/wpa_supplicant/wpa_supplicant.conf -B -ieth1 &
route add default gw 192.168.1.1
ntpdate -b -u pool.ntp.org

And it works all the time..

The only difference i've noticed is that my script run this
ibook mambro # ps aux | grep wpa
root      9517  0.0  0.2   4700   560 ?        Ss   14:39   0:00 wpa_supplicant -Dwext -c/etc/wpa_supplicant/wpa_supplicant.conf -B -ieth1

and the init script run this
root      8240  0.0  0.4   4700  1096 ?        Ss   14:34   0:00 /sbin/wpa_supplicant -Dwext -c/etc/wpa_supplicant/wpa_supplicant.conf -W -B -ieth1 -P/var/run/wpa_supplicant-eth1.pid
root      8251  0.0  0.2   2456   536 ?        Ss   14:34   0:00 /bin/wpa_cli -a/etc/wpa_supplicant/wpa_cli.sh -p/var/run/wpa_supplicant -ieth1 -P/var/run/wpa_cli-eth1.pid -B

it use the "-W" option for wpa_supplicant... what does it mean? i haven't found nothing in the man page... could be this option the problem?

Reproducible: Always

Steps to Reproduce:




Comment 1


Roy Marples (RETIRED)






          2007-02-18 15:06:15 UTC
        

Don't set associate_timeout_eth1. Instead let it configure in the background.

The -W option instructs wpa_supplicant to wait for wpa_cli to connect. wpa_cli listens to wpa_supplicant and is the middleman between wpa_supplcant and our init system.




Comment 2


mambro





          2007-02-18 17:51:47 UTC
        

Nothing changes if i delete that line.. 
With associate_timeout_eth1 unset i've the same problem...




Comment 3


mambro





          2007-02-28 17:07:08 UTC
        

There're some information I can give you to help you fixing the problem?




Comment 4


Roy Marples (RETIRED)






          2007-02-28 17:21:15 UTC
        

Yes, with the timeout removed, what is the output of `wpa_cli status` and `ifconfig eth1`




Comment 5


mambro





          2007-02-28 19:34:56 UTC
        

that's what happens:

ibook mambro # /etc/init.d/net.eth1 start
 * Starting eth1
 *   Starting wpa_supplicant on eth1 ...                                  [ ok ]
 *   Starting wpa_cli on eth1 ...                                         [ ok ]
 *     Backgrounding ...
ibook mambro # wpa_cli status
Selected interface 'eth1'
bssid=00:18:4d:12:57:ea
ssid=MambroWIFI
id=0
pairwise_cipher=TKIP
group_cipher=TKIP
key_mgmt=WPA-PSK
wpa_state=COMPLETED
ip_address=192.168.1.4
ibook mambro # ifconfig eth1
eth1      Link encap:Ethernet  HWaddr 00:11:24:20:9B:6B
          inet addr:192.168.1.4  Bcast:0.0.0.0  Mask:255.255.255.255
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:8 errors:0 dropped:1 overruns:0 frame:0
          TX packets:108 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:960 (960.0 b)  TX bytes:5137 (5.0 Kb)
          Interrupt:52 Base address:0x8000
ibook mambro # ping router
connect: Network is unreachable
ibook mambro # ping www.google.it
ping: unknown host www.google.it


the strange thin is that with my script it's the same but it works..
ibook mambro # ./connectWiFi 
 * Unmounting network filesystems ...                                                                                  [ ok ]
 * Stopping eth1
 *   Bringing down eth1
 *     Shutting down eth1 ...                                                                                          [ ok ]
 *     Stopping wpa_cli on eth1 ...                                                                                    [ ok ]
 *     Stopping wpa_supplicant on eth1 ...                                                                             [ ok ]
 * WARNING:  net.eth0 has not yet been started.
wpa_supplicant: nessun processo terminato
wpa_cli: nessun processo terminato
28 Feb 20:29:24 ntpdate[7311]: step time server 86.59.13.46 offset -804.097134 sec
ibook mambro # wpa_cli status
Selected interface 'eth1'
bssid=00:18:4d:12:57:ea
ssid=MambroWIFI
id=0
pairwise_cipher=TKIP
group_cipher=TKIP
key_mgmt=WPA-PSK
wpa_state=COMPLETED
ip_address=192.168.1.4
ibook mambro # ifconfig eth1
eth1      Link encap:Ethernet  HWaddr 00:11:24:20:9B:6B  
          inet addr:192.168.1.4  Bcast:192.168.1.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:54 errors:0 dropped:0 overruns:0 frame:0
          TX packets:84 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:5086 (4.9 Kb)  TX bytes:6357 (6.2 Kb)
          Interrupt:52 Base address:0x4000 

ibook mambro # ping router
PING router (192.168.1.1) 56(84) bytes of data.
64 bytes from router (192.168.1.1): icmp_seq=1 ttl=255 time=2.22 ms
64 bytes from router (192.168.1.1): icmp_seq=2 ttl=255 time=1.90 ms

--- router ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt min/avg/max/mdev = 1.906/2.063/2.220/0.157 ms
ibook mambro # ping www.google.it
PING www.l.google.com (209.85.129.104) 56(84) bytes of data.
64 bytes from fk-in-f104.google.com (209.85.129.104): icmp_seq=1 ttl=243 time=63.9 ms

--- www.l.google.com ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 63.900/63.900/63.900/0.000 ms





Comment 6


Roy Marples (RETIRED)






          2007-02-28 20:49:09 UTC
        

It looks like a DNS issue more than anything else.

Can you ping 192.168.1.1 instead of router?




Comment 7


mambro





          2007-02-28 21:12:54 UTC
        

No, i can't ping neither 192.168.1.1 :-(

If could be usefull that are my logs after i start /etc/init.d/net.eth1

bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Chip initialized
bcm43xx: 30-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
SoftMAC: Scanning finished
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Scanning finished
SoftMAC: Unable to find matching network after scan!
SoftMAC: generic IE set to dd162250f20101c230050f20256700050f20201000050f333
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Queueing Authentication Request to 00:18:4d:12:57:ea
SoftMAC: Cannot associate without being authenticated, requested authentication
SoftMAC: Sent Authentication Request to 00:18:4d:12:57:ea.
SoftMAC: Open Authentication completed with 00:18:4d:12:57:ea
SoftMAC: sent association request!
SoftMAC: associated!
ieee80211_crypt: registered algorithm 'TKIP'
SoftMAC: Scanning finished
bcm43xx: set security called, .active_key = 0, .level = 2, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .enabled = 1, .encrypt = 1
hda: drive_cmd: status=0x51 { DriveReady SeekComplete Error }
hda: drive_cmd: error=0x04 { AbortedCommand }
ide: failed opcode was: 0xe3
Netfilter messages via NETLINK v0.30.
ip_conntrack version 2.4 (2048 buckets, 16384 max) - 228 bytes per conntrack
agpgart: Putting AGP V2 device at 0000:00:0b.0 into 4x mode
agpgart: Putting AGP V2 device at 0000:00:10.0 into 4x mode
[drm] Loading R200 Microcode


and that is after i start my script
bcm43xx: Radio turned off
bcm43xx: DMA-32 0x0200 (RX) max used slots: 1/64
bcm43xx: DMA-32 0x02A0 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0280 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0260 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0240 (TX) max used slots: 0/512
bcm43xx: DMA-32 0x0220 (TX) max used slots: 4/512
bcm43xx: DMA-32 0x0200 (TX) max used slots: 0/512
bcm43xx: set security called, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Associate: failed to initiate scan. Is device up?
ieee80211: 802.11 data/management/control stack, git-1.1.13
ieee80211: Copyright (C) 2004-2005 Intel Corporation <jketreno@linux.intel.com>
bcm43xx driver
bcm43xx: Chip ID 0x4306, rev 0x3
bcm43xx: Number of cores: 5
bcm43xx: Core 0: ID 0x800, rev 0x4, vendor 0x4243, enabled
bcm43xx: Core 1: ID 0x812, rev 0x5, vendor 0x4243, disabled
bcm43xx: Core 2: ID 0x80d, rev 0x2, vendor 0x4243, enabled
bcm43xx: Core 3: ID 0x807, rev 0x2, vendor 0x4243, disabled
bcm43xx: Core 4: ID 0x804, rev 0x9, vendor 0x4243, enabled
bcm43xx: PHY connected
bcm43xx: Detected PHY: Version: 2, Type 2, Revision 2
bcm43xx: Detected Radio: ID: 2205017f (Manuf: 17f Ver: 2050 Rev: 2)
bcm43xx: Radio turned off
bcm43xx: Radio turned off
bcm43xx: PHY connected
bcm43xx: Microcode rev 0x127, pl 0xe (2005-04-18  02:36:27)
bcm43xx: Radio turned on
bcm43xx: Chip initialized
bcm43xx: 30-bit DMA initialized
bcm43xx: Keys cleared
bcm43xx: Selected 802.11 core (phytype 2)
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
bcm43xx: set security called, .level = 0, .enabled = 0, .encrypt = 0
SoftMAC: generic IE set to dd162250f20101c230050f20256700050f20201000050f333
SoftMAC: Associate: Scanning for networks first.
SoftMAC: Start scanning with channel: 1
SoftMAC: Scanning 14 channels
SoftMAC: Queueing Authentication Request to 00:18:4d:12:57:ea
SoftMAC: Cannot associate without being authenticated, requested authentication
SoftMAC: Sent Authentication Request to 00:18:4d:12:57:ea.
SoftMAC: Open Authentication completed with 00:18:4d:12:57:ea
SoftMAC: sent association request!
SoftMAC: associated!
SoftMAC: Scanning finished
bcm43xx: set security called, .active_key = 0, .level = 2, .enabled = 1, .encrypt = 1
bcm43xx: set security called, .enabled = 1, .encrypt = 1

i can see that the gentoo init script say:
SoftMAC: Unable to find matching network after scan!
could be the problem...




Comment 8


Anthony Russello





          2007-04-19 01:17:54 UTC
        

Hi,

I am having the same issue, both myself and a friend.

Prior to the baselayout update we just did, we were having no problems with wireless, but now when our wireless starts, wpa_cli shows we have connected and authenticate, but dhcpcd isn't being started to obtain an IP address.  We have to manually initiate this after the fact.

Here's /etc/conf.d/net from my system:
<snip>
# Wired Ethernet
config_eth0=( "dhcp" )
dhcp_eth0="nonis nodns nontp"
modules_eth0=( "ifplugd" )
ifplugd_eth0=( "--no-beep --ignore-fail --ignore-retval --poll-time=1 --delay-up=0 --delay-down=0 --monitor" )

# 1394 Ethernet
#  Not Configured... nothing to test with.

# Wireless (BCM43xx)
config_eth2=( "dhcp" )
modules_eth2=( "!iwconfig" "wpa_supplicant" "!ifplugd" )
wpa_supplicant_eth2=( "-Dwext" )
dhcpcd_eth2=( "-o" )
dhcp_eth2="nonis nodns nontp"
</snip>

Here's the output of wpa_cli->status
<snip>
> status
bssid=00:aa:bb:cc:dd:ee
ssid=protected
id=0
pairwise_cipher=CCMP
group_cipher=CCMP
key_mgmt=WPA-PSK
wpa_state=COMPLETED
</snip>

after running dhcpcd eth2:

<snip>
> status
bssid=00:aa:bb:cc:dd:ee
ssid=protected
id=0
pairwise_cipher=CCMP
group_cipher=CCMP
key_mgmt=WPA-PSK
wpa_state=COMPLETED
ip_address=192.168.1.14
</snip>

Prior to the baselayout update, dhcpcd was running automatically and obtaining an IP address.  Now after the update, I'm experiencing issues.

Any ideas?  Can I do anything else to help?




Comment 9


Anthony Russello





          2007-04-19 02:18:45 UTC
        

> # Wireless (BCM43xx)
> config_eth2=( "dhcp" )
> modules_eth2=( "!iwconfig" "wpa_supplicant" "!ifplugd" )
> wpa_supplicant_eth2=( "-Dwext" )
> dhcpcd_eth2=( "-o" )
> dhcp_eth2="nonis nodns nontp"

Hi,

I just found my problem, sorry about that.

It was the -o option to dhcpcd.  Removed dhcpcd_eth2=( "-o" ) resolved my issue.

Thanks,
Anthony




Comment 10


Roy Marples (RETIRED)






          2007-04-19 06:59:55 UTC
        

(In reply to comment #0)
> My /etc/conf.d/net is like that
> config_eth1=( "192.168.1.4" )
> routes_eth1=( "default via 192.168.1.1" )

I think that is the error. You've missed the netmask off.
config_eth1=( "192.168.1.4/24" )
routes_eth1=( "default via 192.168.1.1" )

Should work.
If not, please re-open









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


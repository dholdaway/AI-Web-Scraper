Title: Add Kamal by default to Rails 8 by dhh · Pull Request #51798 · rails/rails · GitHub
URL: https://github.com/rails/rails/pull/51798/files

Skip to content




















Navigation Menu

Toggle navigation




 













            Sign in
          








        Product
        













GitHub Copilot
        Write better code with AI
      







Security
        Find and fix vulnerabilities
      







Actions
        Automate any workflow
      







Codespaces
        Instant dev environments
      







Issues
        Plan and track work
      







Code Review
        Manage code changes
      







Discussions
        Collaborate outside of code
      







Code Search
        Find more, search less
      






Explore



      All features

    



      Documentation

    





      GitHub Skills

    





      Blog

    










        Solutions
        






By company size



      Enterprises

    



      Small and medium teams

    



      Startups

    




By use case



      DevSecOps

    



      DevOps

    



      CI/CD

    



      View all use cases

    






By industry



      Healthcare

    



      Financial services

    



      Manufacturing

    



      Government

    



      View all industries

    






              View all solutions
              


 




        Resources
        






Topics



      AI

    



      DevOps

    



      Security

    



      Software Development

    



      View all

    






Explore



      Learning Pathways

    





      White papers, Ebooks, Webinars

    





      Customer Stories

    



      Partners

    










        Open Source
        










GitHub Sponsors
        Fund open source developers
      








The ReadME Project
        GitHub community articles
      




Repositories



      Topics

    



      Trending

    



      Collections

    








        Enterprise
        













Enterprise platform
        AI-powered developer platform
      




Available add-ons







Advanced Security
        Enterprise-grade security features
      







GitHub Copilot
        Enterprise-grade AI features
      







Premium Support
        Enterprise-grade 24/7 support
      







Pricing












Search or jump to...







Search code, repositories, users, issues, pull requests...

 




        Search
      













Clear
 
















































 




              Search syntax tips
 














        Provide feedback
      









 
We read every piece of feedback, and take your input very seriously.


Include my email address so I can be contacted


     Cancel

    Submit feedback










        Saved searches
      
Use saved searches to filter your results more quickly









 





Name






Query



            To see all available qualifiers, see our documentation.
          
 





     Cancel

    Create saved search








                Sign in
              


                Sign up
              
Reseting focus









You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.
 


Dismiss alert



















        rails
 
/

rails

Public





 

Notifications
 You must be signed in to change notification settings


 

Fork
    21.6k




 


          Star
 56k














Code







Issues
517






Pull requests
743






Discussions







Actions







Security







Insights



 

 


Additional navigation options


 










          Code











          Issues











          Pull requests











          Discussions











          Actions











          Security











          Insights






 















    
    New issue
  

 


 







Have a question about this project? Sign up for a free GitHub account to open an issue and contact its maintainers and the community.
  

    Sign up for GitHub


By clicking “Sign up for GitHub”, you agree to our terms of service and
  privacy statement. We’ll occasionally send you account related emails.

    Already on GitHub?
    Sign in
    to your account
  





Jump to bottom



Add Kamal by default to Rails 8
#51798






 Merged



dhh
  merged 18 commits into


  main

from

kamal-by-default







 

May 14, 2024










      Conversation

      13





      Commits

      18





  Checks

  3





      Files changed

    











 Merged







    Add Kamal by default to Rails 8
  
#51798






 


 Show file tree


 


 Hide file tree



    Changes from all commits



Commits





            Show all changes
          

            18 commits
          



        Select commit
          Hold shift + click to select a range




b6bf5be

                Add Kamal by default
              

                dhh May 12, 2024





d3c637d

                More default files
              

                dhh May 12, 2024





e753438

                Fix order
              

                dhh May 13, 2024





25e7933

                Fix skip call
              

                dhh May 13, 2024





a98b1bf

                Consolidate kamal install to a single action
              

                dhh May 13, 2024





ab66688

                Style
              

                dhh May 13, 2024





f3dd061

                Words
              

                dhh May 13, 2024





bc3ffe4

                Fix tests
              

                dhh May 13, 2024





13aec96

                No longer default given when these are generated
              

                dhh May 13, 2024





c8b7dcd

                Use a default, persistent storage volume
              

                dhh May 13, 2024





0a95193

                Allow Kamal-configured apps to has sqlite3 database production path s…
              

                dhh May 13, 2024





779f9ae

                Document builder setup better
              

                dhh May 13, 2024





0eb1f71

                Show use of ENV lookup
              

                dhh May 13, 2024





7515a93

                Cant have an empty clear
              

                dhh May 14, 2024





35f6780

                Scope named docker volume to app name
              

                dhh May 14, 2024





48f1b9b

                Add CHANGELOG entry
              

                dhh May 14, 2024





74bc7b2

                Merge branch 'main' into kamal-by-default
              

                dhh May 14, 2024





c4c113c

                Strangling notice
              

                dhh May 14, 2024











        File filter
      




Filter by extension




Filter by extension


                  .md&nbsp
                  
                    (1)
                  



                  .rb&nbsp
                  
                    (4)
                  



                  .tt&nbsp
                  
                    (4)
                  




                  All 3 file types selected
                





              Viewed files
            
 








 Clear filters




 Conversations
 


          Failed to load comments.       Retry







 Loading







 Jump to
 


          Jump to file
        



          Failed to load files.       Retry







 Loading







 




 

          Diff view











                      Unified
                    

 








                      Split
                    

 




Hide whitespace


    Apply and reload







 

Show whitespace



 




 

          Diff view











                      Unified
                    

 








                      Split
                    

 




Hide whitespace


    Apply and reload














 


























        railties
      



railties/CHANGELOG.md







        CHANGELOG.md
      




















        lib/rails/generators
      



railties/lib/rails/generators/app_base.rb







        app_base.rb
      




















        rails
      















        app
      



railties/lib/rails/generators/rails/app/app_generator.rb







        app_generator.rb
      




















        templates
      



railties/lib/rails/generators/rails/app/templates/Gemfile.tt







        Gemfile.tt
      




















        config
      















        databases
      



railties/lib/rails/generators/rails/app/templates/config/databases/sqlite3.yml.tt







        sqlite3.yml.tt
      










railties/lib/rails/generators/rails/app/templates/config/deploy.yml.tt







        deploy.yml.tt
      










railties/lib/rails/generators/rails/app/templates/env.erb.tt







        env.erb.tt
      
























        plugin
      



railties/lib/rails/generators/rails/plugin/plugin_generator.rb







        plugin_generator.rb
      


























        test/generators
      



railties/test/generators/app_generator_test.rb







        app_generator_test.rb
      


























        There are no files selected for viewing

 















            4 changes: 4 additions & 0 deletions
          
4 

railties/CHANGELOG.md








 






 




  




 














              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change











@@ -1,2 +1,6 @@





*   Use Kamal for deployment by default, which includes generating a Rails-specific config/deploy.yml.





    This can be skipped using --skip-kamal. See more: https://kamal-deploy.org/











    *DHH* 











Please check [7-2-stable](https://github.com/rails/rails/blob/7-2-stable/railties/CHANGELOG.md) for previous changes.



 




























            17 changes: 17 additions & 0 deletions
          
17 

railties/lib/rails/generators/app_base.rb








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change










Expand Up

@@ -112,6 +112,9 @@ def self.add_shared_options_for(name)





        class_option :skip_devcontainer,   type: :boolean, default: false,





                                           desc: "Skip devcontainer files"











        class_option :skip_kamal,          type: :boolean, default: false,





                                           desc: "Skip Kamal setup"











        class_option :dev,                 type: :boolean, default: nil,





                                           desc: "Set up the #{name} with Gemfile pointing to your Rails checkout"














Expand Down





Expand Up

@@ -407,6 +410,10 @@ def skip_devcontainer?





        options[:skip_devcontainer]





      end











      def skip_kamal?





        options[:skip_kamal]





      end











      class GemfileEntry < Struct.new(:name, :version, :comment, :options, :commented_out)





        def initialize(name, version, comment, options = {}, commented_out = false)





          super








Expand Down





Expand Up

@@ -718,6 +725,16 @@ def run_css





        end





      end











      def run_kamal





        return if options[:skip_kamal] || !bundle_install?











        bundle_command "binstubs kamal"





        bundle_command "exec kamal init"











        template "env.erb", ".env.erb"





        template "config/deploy.yml", force: true





      end











      def add_bundler_platforms





        if bundle_install?





          # The vast majority of Rails apps will be deployed on `x86_64-linux`.








Expand Down





 




























            1 change: 1 addition & 0 deletions
          
1 

railties/lib/rails/generators/rails/app/app_generator.rb








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop













Original file line number
Diff line number
Diff line change










Expand Up

@@ -570,6 +570,7 @@ def finish_template





 public_task :run_javascript





 public_task :run_hotwire





 public_task :run_css





 public_task :run_kamal











 def run_after_bundle_callbacks





 @after_bundle_callbacks.each(&:call)








Expand Down


































            5 changes: 5 additions & 0 deletions
          
5 

railties/lib/rails/generators/rails/app/templates/Gemfile.tt








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change










Expand Up

@@ -19,6 +19,11 @@ gem "tzinfo-data", platforms: %i[ <%= bundler_windows_platforms %> jruby ]





# Reduces boot times through caching; required in config/boot.rb





gem "bootsnap", require: false





<% end -%>





<% unless options.skip_kamal? -%>











# Deploy this application anywhere as a Docker container [https://kamal-deploy.org]





gem "kamal", require: false





<% end -%>





<% unless skip_active_storage? -%>











# Use Active Storage variants [https://guides.rubyonrails.org/active_storage_overview.html#transforming-images]








Expand Down





 




























            8 changes: 8 additions & 0 deletions
          
8 

railties/lib/rails/generators/rails/app/templates/config/databases/sqlite3.yml.tt








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change










Expand Up

@@ -21,6 +21,7 @@ test:





  database: storage/test.sqlite3

















<%- if options.skip_kamal? -%>





# SQLite3 write its data on the local filesystem, as such it requires





# persistent disks. If you are deploying to a managed service, you should





# make sure it provides disk persistence, as many don't.








Expand All

@@ -30,3 +31,10 @@ test:





production:





  <<: *default





  # database: path/to/persistent/storage/production.sqlite3





<%- else -%>





# Store production database in the storage/ directory, which by default





# is mounted as a persistent Docker volume in config/deploy.yml.





production:





  <<: *default





  database: storage/production.sqlite3





<%- end -%>









 
















            85 changes: 85 additions & 0 deletions
          
85 

railties/lib/rails/generators/rails/app/templates/config/deploy.yml.tt








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change






@@ -0,0 +1,85 @@





# Name of your application. Used to uniquely configure containers.





service: <%= app_name %>











# Name of the container image.





image: your-user/<%= app_name %>











# Deploy to these servers.





servers:





  web:





    - 192.168.0.1





  # job:





  #   hosts:





  #     - 192.168.0.1





  #   cmd: bin/solid_queue work











# Credentials for your image host.





registry:





  # Specify the registry server, if you're not using Docker Hub





  # server: registry.digitalocean.com / ghcr.io / ...





  username: your-user











  # Always use an access token rather than real password when possible.





  password:





    - KAMAL_REGISTRY_PASSWORD











# Inject ENV variables into containers (secrets come from .env).





# Remember to run `kamal env push` after making changes!





env:





  secret:





    - RAILS_MASTER_KEY





  # clear:





  #   DB_HOST: 192.168.0.2











# Use a persistent storage volume for sqlite database files and local Active Storage files.





# Recommended to change this to a mounted volume path that is backed up off server.





volumes:





  - "<%= app_name %>_storage:/rails/storage"











# Bridge fingerprinted assets, like JS and CSS, between versions to avoid





# hitting 404 on in-flight requests. Combines all files from new and old





# version inside the asset_path.





asset_path: /rails/public/assets











# Use a different ssh user than root





# ssh:





#   user: app











# Configure builder setup (defaults to multi-arch images).





# builder:





#   # Build same-arch image locally (use for x86->x86)





#   multiarch: false





#





#   # Build diff-arch image via remote server





#   remote:





#     arch: amd64





#     host: ssh://app@192.168.0.1





#





#   args:





#     RUBY_VERSION: <%= ENV["RBENV_VERSION"] || ENV["rvm_ruby_string"] || "#{RUBY_ENGINE}-#{RUBY_ENGINE_VERSION}" %>





#   secrets:





#     - GITHUB_TOKEN





#     - RAILS_MASTER_KEY











# Use accessory services (secrets come from .env).





# accessories:





#   db:





#     image: mysql:8.0





#     host: 192.168.0.2





#     port: 3306





#     env:





#       clear:





#         MYSQL_ROOT_HOST: '%'





#       secret:





#         - MYSQL_ROOT_PASSWORD





#     files:





#       - config/mysql/production.cnf:/etc/mysql/my.cnf





#       - db/production.sql:/docker-entrypoint-initdb.d/setup.sql





#     directories:





#       - data:/var/lib/mysql





#   redis:





#     image: redis:7.0





#     host: 192.168.0.2





#     port: 6379





#     directories:





#       - data:/data



 
















            5 changes: 5 additions & 0 deletions
          
5 

railties/lib/rails/generators/rails/app/templates/env.erb.tt








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change






@@ -0,0 +1,5 @@





<%%# This env template should lookup values from a password store or from ENV -%>





# Generated by kamal envify from .env.erb





KAMAL_REGISTRY_PASSWORD=<%%= ENV["KAMAL_REGISTRY_PASSWORD"] %>





RAILS_MASTER_KEY=<%%= File.read("config/master.key") %>





# GITHUB_TOKEN=<%%#= `gh config get -h github.com oauth_token`.strip %>






 


dhh marked this conversation as resolved.
            



Show resolved


Hide resolved


 













 




























            1 change: 1 addition & 0 deletions
          
1 

railties/lib/rails/generators/rails/plugin/plugin_generator.rb








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change










Expand Up

@@ -115,6 +115,7 @@ def generate_test_dummy(force = false)





      opts[:skip_brakeman] = true





      opts[:skip_bundle] = true





      opts[:skip_ci] = true





      opts[:skip_kamal] = true





      opts[:skip_git] = true





      opts[:skip_hotwire] = true





      opts[:skip_rubocop] = true








Expand Down





 




























            14 changes: 14 additions & 0 deletions
          
14 

railties/test/generators/app_generator_test.rb








 



















              Show comments
            


   View file


      Edit file
    

    Delete file
  



    Open in desktop















Original file line number
Diff line number
Diff line change










Expand Up

@@ -654,6 +654,20 @@ def test_ci_files_are_skipped_if_required





    assert_no_file ".github/dependabot.yml"





  end











  def test_inclusion_of_kamal_files





    run_generator_and_bundler [destination_root]











    assert_file "config/deploy.yml"





    assert_file ".env.erb"





  end











  def test_kamal_files_are_skipped_if_required





    run_generator_and_bundler [destination_root, "--skip-kamal"]











    assert_no_file "config/deploy.yml"





    assert_no_file ".env.erb"





  end











  def test_usage_read_from_file





    assert_called(File, :read, returns: "USAGE FROM FILE") do





      assert_equal "USAGE FROM FILE", Rails::Generators::AppGenerator.desc








Expand Down





 










 Loading





      Oops, something went wrong.
            Retry





Toggle all file notes
Toggle all file annotations
























 




Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.











Footer








        © 2024 GitHub, Inc.
      


Footer navigation


Terms


Privacy


Security


Status


Docs


Contact




      Manage cookies
    





      Do not share my personal information
    
















    You can’t perform that action at this time.


Title: 190898 – Tap aio device failed working with xen 3.1.0 with kernel-2.6.20-xen-r2
URL: https://bugs.gentoo.org/show_bug.cgi?id=190898

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 190898
Tap aio device failed working with xen 3.1.0 with kernel-2.6.20-xen-r2
Last modified: 2011-03-26 11:26:37 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 190898 
      - Tap aio device failed working with xen 3.1.0 with kernel-2.6.20-xen-r2


Summary:
Tap aio device failed working with xen 3.1.0 with kernel-2.6.20-xen-r2
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

[OLD] Server

  (show other bugs)



Hardware:

All
        Linux
      







Importance:
      
High
       major
      


Assignee:

Gentoo Xen Devs








URL:







Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2007-08-31 19:50 UTC by Simon Gao





      Modified:
    
2011-03-26 11:26 UTC
      (History)
    




          CC List:
        

0 
          users
        








See Also:






Package list:







Runtime testing required:

---























      Attachments
    




Kernel config file for 2.6.18-xen-r5

              (kernel-2.6.18-xen0-r5-1,34.96 KB,
                text/plain)

            
2007-10-10 18:27 UTC,

            Simon Gao




Details





Kernel config file for 2.6.20-xen-r4

              (kernel-2.6.20-xen0-r4-1,38.81 KB,
                text/plain)

            
2007-10-10 18:29 UTC,

            Simon Gao




Details





Kernel configuration for kernel 2.6.18-xen-r5 (xen-sources)

              (config-2.6.18-xen-r5,37.56 KB,
                text/plain)

            
2007-10-11 14:44 UTC,

            Oliver Battenfeld




Details





View All

Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


Simon Gao





          2007-08-31 19:50:32 UTC
        

xen-3.1.0 with kernel 2.6.20-xen-r2 does not work with tap aio device, though file based domU works fine. I used overlay for xen-3.1.0 with 2.6.18 which worked without problem on identical setup.

Here is error when a domU boots up:

XENBUS: Timeout connecting to device: device/vbd/769 (state 3)
XENBUS: Timeout connecting to device: device/vbd/770 (state 3)
XENBUS: Device with no driver: device/console/0
VFS: Cannot open root device "hda1" or unknown-block(0,0)
Please append a correct "root=" boot option
Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)

# emerge --info
Portage 2.1.2.12 (default-linux/amd64/2007.0, gcc-4.1.2, glibc-2.5-r4, 2.6.20-xen-r20 x86_64)
=================================================================
System uname: 2.6.20-xen-r20 x86_64 Intel(R) Xeon(TM) CPU 3.00GHz
Gentoo Base System release 1.12.9
Timestamp of tree: Fri, 31 Aug 2007 17:00:10 +0000
app-shells/bash:     3.2_p17
dev-lang/python:     2.4.4-r4
dev-python/pycrypto: 2.0.1-r6
sys-apps/baselayout: 1.12.9-r2
sys-apps/sandbox:    1.2.17
sys-devel/autoconf:  2.61
sys-devel/automake:  1.7.9-r1, 1.8.5-r3, 1.9.6-r2, 1.10
sys-devel/binutils:  2.17
sys-devel/gcc-config: 1.3.16
sys-devel/libtool:   1.5.24
virtual/os-headers:  2.6.21
ACCEPT_KEYWORDS="amd64"
CBUILD="x86_64-pc-linux-gnu"
CFLAGS="-march=nocona -O2 -pipe -fomit-frame-pointer"
CHOST="x86_64-pc-linux-gnu"
CONFIG_PROTECT="/etc"
CONFIG_PROTECT_MASK="/etc/env.d /etc/gconf /etc/revdep-rebuild /etc/terminfo"
CXXFLAGS="-march=nocona -O2 -pipe -fomit-frame-pointer"
DISTDIR="/usr/portage/distfiles"
FEATURES="distlocks metadata-transfer sandbox sfperms strict"
GENTOO_MIRRORS="http://distfiles.gentoo.org http://distro.ibiblio.org/pub/linux/distributions/gentoo"
MAKEOPTS="-j2"
PKGDIR="/usr/portage/packages"
PORTAGE_RSYNC_EXTRA_OPTS="--exclude-from=/etc/portage/rsync_excludes"
PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --compress --force --whole-file --delete --delete-after --stats --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages --filter=H_**/files/digest-*"
PORTAGE_TMPDIR="/var/tmp"
PORTDIR="/usr/portage"
PORTDIR_OVERLAY="/usr/local/portage"
SYNC="rsync://rsync.gentoo.org/gentoo-portage"
USE="acl amd64 berkdb bitmap-fonts cli cracklib crypt cups dri fortran gdbm gpm iconv ipv6 isdnlog mbox midi mmx mudflap ncurses nls nptl nptlonly openmp pam pcre perl pppd python readline reflection session spl sse sse2 ssl tcpd truetype-fonts type1-fonts unicode xorg zlib" ALSA_CARDS="ali5451 als4000 atiixp atiixp-modem bt87x ca0106 cmipci emu10k1x ens1370 ens1371 es1938 es1968 fm801 hda-intel intel8x0 intel8x0m maestro3 trident usb-audio via82xx via82xx-modem ymfpci" ALSA_PCM_PLUGINS="adpcm alaw asym copy dmix dshare dsnoop empty extplug file hooks iec958 ioplug ladspa lfloat linear meter mulaw multi null plug rate route share shm softvol" ELIBC="glibc" INPUT_DEVICES="keyboard mouse evdev" KERNEL="linux" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" USERLAND="GNU" VIDEO_CARDS="apm ark chips cirrus cyrix dummy fbdev glint i128 i810 mach64 mga neomagic nv r128 radeon rendition s3 s3virge savage siliconmotion sis sisusb tdfx tga trident tseng v4l vesa vga via vmware voodoo"
Unset:  CTARGET, EMERGE_DEFAULT_OPTS, INSTALL_MASK, LANG, LC_ALL, LDFLAGS, LINGUAS, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS

Simon




Comment 1


Micheal Marineau (RETIRED)






          2007-08-31 23:58:19 UTC
        

Probably an issue in the 2.6.20 kernel, please try the latest 2.6.18 xen kernel in portage to make sure it is still ok. I haven't tried the tap driver before but I'll take a look soon.




Comment 2


Simon Gao





          2007-09-01 00:08:39 UTC
        

Yes. 2.6.18 kernel works ok. 

However, it would be nice to get 2.6.20 working since bnx2 driver got updated in 2.6.19 and later. The version of bnx2 with 2.6.18 and below does not work well on Dell's servers.

Simon




Comment 3


Simon Gao





          2007-09-01 00:16:32 UTC
        

I mean 2.6.18 xen kernel from portage tree.




Comment 4


Simon Gao





          2007-10-09 17:16:03 UTC
        

It does not work with kernel-2.6.20-xen-r4 either.

Simon






Comment 5


Simon Gao





          2007-10-09 17:19:37 UTC
        

2.6.18-xen-r5 worked ok.






Comment 6


Robert Buchholz (RETIRED)






          2007-10-10 09:08:12 UTC
        

Are you running both kernels with the same config (xen parts)? Can you attach the 2.6.20 config?




Comment 7


Oliver Battenfeld





          2007-10-10 13:06:01 UTC
        

I'm currently running 2.6.18-xen-r5 which doesn't work. None of the 2.6.20 kernels do.

(Running AMD64 with Xen 3.1.0, gcc 4.1.2)




Comment 8


Simon Gao





          2007-10-10 18:27:59 UTC
        

Created attachment 133070 [details]
Kernel config file for 2.6.18-xen-r5

tap:aio works with 2.6.18-xen-r{3,4,5}.




Comment 9


Simon Gao





          2007-10-10 18:29:52 UTC
        

Created attachment 133072 [details]
Kernel config file for 2.6.20-xen-r4

tap:aio does not work even the kernel config file is the same as 2.6.18-xen-r5.




Comment 10


Simon Gao





          2007-10-10 18:33:03 UTC
        

(In reply to comment #7)
> I'm currently running 2.6.18-xen-r5 which doesn't work. None of the 2.6.20
> kernels do.
> 
> (Running AMD64 with Xen 3.1.0, gcc 4.1.2)
> 

The machines I use mostly have Xeon 5310 or Xeon 5320 CPU. I use 64bit Gentoo.

Here is my build environment:


Portage 2.1.3.9 (default-linux/amd64/2007.0, gcc-4.1.2, glibc-2.5-r4, 2.6.18-xen-r50 x86_64)
=================================================================
System uname: 2.6.18-xen-r50 x86_64 Intel(R) Xeon(R) CPU L5320 @ 1.86GHz
Timestamp of tree: Wed, 10 Oct 2007 02:30:01 +0000
app-shells/bash:     3.2_p17
dev-lang/python:     2.4.4-r5
dev-python/pycrypto: 2.0.1-r6
sys-apps/baselayout: 1.12.9-r2
sys-apps/sandbox:    1.2.17
sys-devel/autoconf:  2.13, 2.61-r1
sys-devel/automake:  1.7.9-r1, 1.8.5-r3, 1.9.6-r2, 1.10
sys-devel/binutils:  2.17-r1
sys-devel/gcc-config: 1.3.16
sys-devel/libtool:   1.5.24
virtual/os-headers:  2.6.21
ACCEPT_KEYWORDS="amd64"
CBUILD="x86_64-pc-linux-gnu"
CFLAGS="-march=nocona -O2 -pipe -fomit-frame-pointer"
CHOST="x86_64-pc-linux-gnu"
CONFIG_PROTECT="/etc"
CONFIG_PROTECT_MASK="/etc/env.d /etc/gconf /etc/revdep-rebuild /etc/terminfo"
CXXFLAGS="-march=nocona -O2 -pipe -fomit-frame-pointer"
DISTDIR="/usr/portage/distfiles"
FEATURES="distlocks metadata-transfer sandbox sfperms strict unmerge-orphans userfetch"
GENTOO_MIRRORS="http://distfiles.gentoo.org http://distro.ibiblio.org/pub/linux/distributions/gentoo"
MAKEOPTS="-j2"
PKGDIR="/usr/portage/packages"
PORTAGE_RSYNC_EXTRA_OPTS="--exclude-from=/etc/portage/rsync_excludes"
PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --compress --force --whole-file --delete --delete-after --stats --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages --filter=H_**/files/digest-*"
PORTAGE_TMPDIR="/var/tmp"
PORTDIR="/usr/portage"
SYNC="rsync://rsync.gentoo.org/gentoo-portage"
USE="acl amd64 berkdb bitmap-fonts cli cracklib crypt cups dri fortran gdbm gpm iconv ipv6 isdnlog mbox midi mmx mudflap ncurses nls nptl nptlonly openmp pam pcre perl pppd python readline reflection session spl sse sse2 ssl tcpd truetype-fonts type1-fonts unicode xorg zlib" ALSA_CARDS="ali5451 als4000 atiixp atiixp-modem bt87x ca0106 cmipci emu10k1x ens1370 ens1371 es1938 es1968 fm801 hda-intel intel8x0 intel8x0m maestro3 trident usb-audio via82xx via82xx-modem ymfpci" ALSA_PCM_PLUGINS="adpcm alaw asym copy dmix dshare dsnoop empty extplug file hooks iec958 ioplug ladspa lfloat linear meter mulaw multi null plug rate route share shm softvol" ELIBC="glibc" INPUT_DEVICES="keyboard mouse evdev" KERNEL="linux" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" USERLAND="GNU" VIDEO_CARDS="apm ark chips cirrus cyrix dummy fbdev glint i128 i810 mach64 mga neomagic nv r128 radeon rendition s3 s3virge savage siliconmotion sis sisusb tdfx tga trident tseng v4l vesa vga via vmware voodoo"
Unset:  CTARGET, EMERGE_DEFAULT_OPTS, INSTALL_MASK, LANG, LC_ALL, LDFLAGS, LINGUAS, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS, PORTDIR_OVERLAY





Comment 11


Oliver Battenfeld





          2007-10-11 14:44:09 UTC
        

Created attachment 133140 [details]
Kernel configuration for kernel 2.6.18-xen-r5 (xen-sources)




Comment 12


Oliver Battenfeld





          2007-10-11 14:45:16 UTC
        

I'm running 64 bit on an Opteron 246 system. Here's my build environment + kernel config:

Portage 2.1.3.12 (default-linux/amd64/2007.0, gcc-4.2.1, glibc-2.6.1-r0, 2.6.18-xen-r5 x86_64)
=================================================================
System uname: 2.6.18-xen-r5 x86_64 AMD Opteron(tm) Processor 246
Timestamp of tree: Thu, 11 Oct 2007 12:50:01 +0000
app-shells/bash:     3.2_p17-r1
dev-lang/python:     2.4.4-r4, 2.5.1-r2
dev-python/pycrypto: 2.0.1-r6
sys-apps/baselayout: 1.12.10-r5
sys-apps/sandbox:    1.2.18.1
sys-devel/autoconf:  2.13, 2.61-r1
sys-devel/automake:  1.4_p6, 1.5, 1.9.6-r2, 1.10
sys-devel/binutils:  2.18-r1
sys-devel/gcc-config: 1.4.0-r4
sys-devel/libtool:   1.5.24
virtual/os-headers:  2.6.22-r2
ACCEPT_KEYWORDS="amd64 ~amd64"
CBUILD="x86_64-pc-linux-gnu"
CFLAGS="-march=opteron -O2 -pipe -mno-tls-direct-seg-refs"
CHOST="x86_64-pc-linux-gnu"
CONFIG_PROTECT="/etc"
CONFIG_PROTECT_MASK="/etc/env.d /etc/gconf /etc/revdep-rebuild /etc/terminfo /etc/udev/rules.d"
CXXFLAGS="-march=opteron -O2 -pipe -mno-tls-direct-seg-refs"
DISTDIR="/usr/portage/distfiles"
FEATURES="distlocks metadata-transfer sandbox sfperms strict unmerge-orphans userfetch"
GENTOO_MIRRORS="http://linux.rz.ruhr-uni-bochum.de/download/gentoo-mirror/ ftp://linux.rz.ruhr-uni-bochum.de/gentoo-mirror/ http://ftp.uni-erlangen.de/pub/mirrors/gentoo ftp://ftp.uni-erlangen.de/pub/mirrors/gentoo http://ftp-stud.fht-esslingen.de/pub/Mirrors/gentoo/ ftp://ftp-stud.fht-esslingen.de/pub/Mirrors/gentoo/ "
MAKEOPTS="-j2"
PKGDIR="/usr/portage/packages"
PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --compress --force --whole-file --delete --delete-after --stats --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages --filter=H_**/files/digest-*"
PORTAGE_TMPDIR="/var/tmp"
PORTDIR="/usr/portage"
SYNC="rsync://rsync.europe.gentoo.org/gentoo-portage"
USE="acl acpi amd64 berkdb bitmap-fonts bzip2 cli cracklib crypt cups dri expat fortran gdbm gnutls gpm iconv ipv6 isdnlog midi mmx mudflap ncurses nls nptl nptlonly openmp pam pcre perl pppd python readline reflection session spl sse sse2 ssl tcpd threads truetype-fonts type1-fonts xen xorg zlib" ALSA_CARDS="ali5451 als4000 atiixp atiixp-modem bt87x ca0106 cmipci emu10k1x ens1370 ens1371 es1938 es1968 fm801 hda-intel intel8x0 intel8x0m maestro3 trident usb-audio via82xx via82xx-modem ymfpci" ALSA_PCM_PLUGINS="adpcm alaw asym copy dmix dshare dsnoop empty extplug file hooks iec958 ioplug ladspa lfloat linear meter mulaw multi null plug rate route share shm softvol" ELIBC="glibc" INPUT_DEVICES="keyboard mouse evdev" KERNEL="linux" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" USERLAND="GNU" VIDEO_CARDS="apm ark chips cirrus cyrix dummy fbdev glint i128 i810 mach64 mga neomagic nv r128 radeon rendition s3 s3virge savage siliconmotion sis sisusb tdfx tga trident tseng v4l vesa vga via vmware voodoo"
Unset:  CTARGET, EMERGE_DEFAULT_OPTS, INSTALL_MASK, LANG, LC_ALL, LDFLAGS, LINGUAS, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS, PORTAGE_RSYNC_EXTRA_OPTS, PORTDIR_OVERLAY




Comment 13


Simon Gao





          2007-10-11 22:08:43 UTC
        

Checked 2.6.18-xen-r6 and 2.6.20-xen-r5.

2.6.18-xen-r6 worked, but 2.6.20-xen-r5 did not.






Comment 14


Micheal Marineau (RETIRED)






          2007-10-11 22:22:11 UTC
        

(In reply to comment #13)
> Checked 2.6.18-xen-r6 and 2.6.20-xen-r5.
> 
> 2.6.18-xen-r6 worked, but 2.6.20-xen-r5 did not.
> 

Right, something went wrong in RedHat's port of xen from 2.6.18 to 2.6.20 for tap aio and I have not had a chance to debug it yet (or bug the redhat folks to see if they know anything). Or maybe I missed a patch in the redhat kernel that i should have copied over. I'll post a note here as soon as I have a chance to dig into this.




Comment 15


Simon Gao





          2007-10-13 19:46:32 UTC
        

The ebuild files for 2.6.18-xen-r6 and 2.6.20-xen-r5 are basically same except the kernel and xen patch version. Maybe comparing patch version will provide some hints?

It's kind of strange. 2.6.20 has higher version number for kernel patch, but lower version number for xen patch. Is that intentional?

Why can't 2.6.20 use the same xen patch version?

I would say the later version of xen patch may include the fix for tap:aio?

Simon

===========================================================================
$ diff /usr/portage/sys-kernel/xen-sources/xen-sources-2.6.18-r6.ebuild /usr/portage/sys-kernel/xen-sources/xen-sources-2.6.20-r5.ebuild
3c3
< # $Header: /var/cvsroot/gentoo-x86/sys-kernel/xen-sources/xen-sources-2.6.18-r6.ebuild,v 1.1 2007/10/10 23:37:10 marineam Exp $
---
> # $Header: /var/cvsroot/gentoo-x86/sys-kernel/xen-sources/xen-sources-2.6.20-r5.ebuild,v 1.1 2007/10/10 22:07:43 marineam Exp $
8c8
< K_GENPATCHES_VER="10"
---
> K_GENPATCHES_VER="19"
17c17
< XENPATCHES_VER="5"
---
> XENPATCHES_VER="3"
23a24,25
>
> DEPEND="${DEPEND} >=sys-devel/binutils-2.17"





Comment 16


Micheal Marineau (RETIRED)






          2007-10-13 20:09:37 UTC
        

(In reply to comment #15)
> The ebuild files for 2.6.18-xen-r6 and 2.6.20-xen-r5 are basically same except
> the kernel and xen patch version. Maybe comparing patch version will provide
> some hints?

Perhaps, but chances are it won't be so trivial.

> 
> It's kind of strange. 2.6.20 has higher version number for kernel patch, but
> lower version number for xen patch. Is that intentional?

The xen-patches tarball for 2.6.18 includes security updates as well so it has to be updated frequently, the 2.6.20 kernel gets its security updates from genpatches instead so the xen patches tarball is only updated for xen bugfixes.

> 
> Why can't 2.6.20 use the same xen patch version?

Because Linux kernels can change a great deal between releases so RedHat's work to forward port xen to 2.6.20 was far from trivial.

> 
> I would say the later version of xen patch may include the fix for tap:aio?

If I or someone else has time to debug it...





Comment 17


Simon Gao





          2008-01-25 05:51:10 UTC
        

Just wonder if there is any update on this.

I've tried xen-sources-2.6.20-r6 with xen 3.1.2. The same problem remains.




Comment 18


Alexey Shvetsov







          2011-03-26 11:26:37 UTC
        

Xen 4.1 in tree. Please test with it and reopen if it doesnt work









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]


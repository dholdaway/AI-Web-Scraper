Title: 711776 – media-libs/libglvnd makes Qt(?) unusable
URL: https://bugs.gentoo.org/show_bug.cgi?id=711776

Go to: 
		Gentoo Home
Documentation
Forums
Lists
Bugs
Planet
Store
Wiki
Get Gentoo!





Gentoo's Bugzilla – Bug 711776
media-libs/libglvnd makes Qt(?) unusable
Last modified: 2020-03-14 16:07:04 UTC node [vulture]


Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]













Bug 711776 
      - media-libs/libglvnd makes Qt(?) unusable


Summary:
media-libs/libglvnd makes Qt(?) unusable
    








Status:
    

RESOLVED
          WORKSFORME
      






Alias:


        None
    





Product:

Gentoo Linux




Classification:

Unclassified




Component:

Current packages

  (show other bugs)



Hardware:

All
        Linux
      







Importance:
      
Normal
       major
      


Assignee:

Gentoo X packagers








URL:







Whiteboard:




Keywords:








Depends on:







Blocks:









 





      Reported:
    
2020-03-07 09:32 UTC by Mark Nowiasz





      Modified:
    
2020-03-14 16:07 UTC
      (History)
    




          CC List:
        

0 
          users
        








See Also:






Package list:







Runtime testing required:

---























      Attachments
    



Add an attachment
        (proposed patch, testcase, etc.)
    








Note
              You need to
              log in
              before you can comment on or make changes to this bug.
            

















Description


Mark Nowiasz





          2020-03-07 09:32:04 UTC
        

This is a rather general bug report, but I'm not exactly sure which component to blame . problably mesa. I'm trying to describe what I did

Reproducible: Always

Steps to Reproduce:
I've started an update run, and shortly after emerging (new, wasn't there before) media-libs/libglvnd-1.3.1 plasma stopped working - I was unable to unlock the screen, switch to a text based virtual console, whatever. Note: I haven't restarted the machine yet.

After rebooting, sddm stopped working, too - so I was unable to login. However, I was able to switch to a console. After some fiddling with downgrading the upgrade I was finally pinpointing the problem: libglvnd.

After USE="-libglvnd" emerge -1 mesa xorg-server and rebooting, everything worked fine.



Portage 2.3.92 (python 3.8.2-final-0, default/linux/amd64/17.1/desktop/plasma/systemd, gcc-9.2.0, glibc-2.30-r4, 5.4.24-gentoo x86_64)
=================================================================
System uname: Linux-5.4.24-gentoo-x86_64-Intel-R-_Core-TM-_i5-8250U_CPU_@_1.60GHz-with-glibc2.4
KiB Mem:    20375540 total,  10995420 free
KiB Swap:    8388604 total,   8388604 free
Timestamp of repository gentoo: Sat, 07 Mar 2020 09:00:01 +0000
Head commit of repository gentoo: d8e0cef1c1473842a3c749e5dcc956841f831bdc
sh bash 5.0_p16
ld GNU ld (Gentoo 2.34 p1) 2.34.0
app-shells/bash:          5.0_p16::gentoo
dev-java/java-config:     2.2.0-r4::gentoo
dev-lang/perl:            5.30.1::gentoo
dev-lang/python:          2.7.17-r1::gentoo, 3.6.10::gentoo, 3.7.6::gentoo, 3.8.2::gentoo, 3.9.0_alpha4::gentoo
dev-util/cmake:           3.16.5::gentoo
dev-util/pkgconfig:       0.29.2::gentoo
sys-apps/baselayout:      2.7::gentoo
sys-apps/sandbox:         2.18::gentoo
sys-devel/autoconf:       2.13-r1::gentoo, 2.69-r5::gentoo
sys-devel/automake:       1.16.1-r2::gentoo
sys-devel/binutils:       2.34::gentoo
sys-devel/gcc:            9.2.0-r4::gentoo
sys-devel/gcc-config:     2.2.1::gentoo
sys-devel/libtool:        2.4.6-r6::gentoo
sys-devel/make:           4.3::gentoo
sys-kernel/linux-headers: 5.5::gentoo (virtual/os-headers)
sys-libs/glibc:           2.30-r4::gentoo
Repositories:

gentoo
    location: /usr/portage
    sync-type: rsync
    sync-uri: rsync://rsync.gentoo.org/gentoo-portage
    priority: -1000
    sync-rsync-verify-jobs: 1
    sync-rsync-verify-metamanifest: yes
    sync-rsync-verify-max-age: 24
    sync-rsync-extra-opts: 

matrix
    location: /var/lib/layman/matrix
    masters: gentoo
    priority: 50

ACCEPT_KEYWORDS="amd64 ~amd64"
ACCEPT_LICENSE="* -@EULA"
CBUILD="x86_64-pc-linux-gnu"
CFLAGS="-march=native -O2 -pipe"
CHOST="x86_64-pc-linux-gnu"
CONFIG_PROTECT="/etc /usr/lib64/libreoffice/program/sofficerc /usr/share/config /usr/share/gnupg/qualified.txt"
CONFIG_PROTECT_MASK="/etc/ca-certificates.conf /etc/dconf /etc/env.d /etc/fonts/fonts.conf /etc/gconf /etc/gentoo-release /etc/revdep-rebuild /etc/sandbox.d /etc/terminfo /etc/texmf/language.dat.d /etc/texmf/language.def.d /etc/texmf/updmap.d /etc/texmf/web2c"
CXXFLAGS="-march=native -O2 -pipe"
DISTDIR="/usr/portage/distfiles"
EMERGE_DEFAULT_OPTS="--keep-going=y"
ENV_UNSET="DBUS_SESSION_BUS_ADDRESS DISPLAY GOBIN PERL5LIB PERL5OPT PERLPREFIX PERL_CORE PERL_MB_OPT PERL_MM_OPT XAUTHORITY XDG_CACHE_HOME XDG_CONFIG_HOME XDG_DATA_HOME XDG_RUNTIME_DIR"
FCFLAGS="-O2 -pipe"
FEATURES="assume-digests binpkg-docompress binpkg-dostrip binpkg-logs config-protect-if-modified distlocks ebuild-locks fixlafiles ipc-sandbox merge-sync multilib-strict network-sandbox news parallel-fetch pid-sandbox preserve-libs protect-owned qa-unresolved-soname-deps sandbox sfperms strict unknown-features-warn unmerge-logs unmerge-orphans userfetch userpriv usersandbox usersync xattr"
FFLAGS="-O2 -pipe"
GENTOO_MIRRORS="http://mirror.eu.oneandone.net/linux/distributions/gentoo/gentoo/ rsync://mirror.eu.oneandone.net/gentoo/ http://mirror.netcologne.de/gentoo/ rsync://mirror.netcologne.de/gentoo/ http://linux.rz.ruhr-uni-bochum.de/download/gentoo-mirror/ http://ftp.halifax.rwth-aachen.de/gentoo/ ftp://ftp.halifax.rwth-aachen.de/gentoo/ rsync://ftp.halifax.rwth-aachen.de/gentoo/ ftp://sunsite.informatik.rwth-aachen.de/pub/Linux/gentoo"
LANG="en_US.utf8"
LDFLAGS="-Wl,-O1 -Wl,--as-needed"
MAKEOPTS="-j8 -l8"
PKGDIR="/usr/portage/packages"
PORTAGE_CONFIGROOT="/"
PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --omit-dir-times --compress --force --whole-file --delete --stats --human-readable --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages --exclude=/.git"
PORTAGE_TMPDIR="/var/tmp"
USE="X a52 aac acl acpi activities alsa amd64 bash-completion berkdb bluetooth branding bzip2 cairo cdda cdr cli crypt cryptsetup cups cxx dbus declarative dri dts dvd dvdr emboss encode exif ffmpeg flac fortran gdbm gif gimp git gles gles2 gpm gtk iconv icu ipv6 jpeg kde kipi kwallet latex lcms ldap libnotify libtirpc mad matroska mmx mng mp3 mp4 mpeg multilib ncurses networkmanager nls nptl ogg opengl openmp pam pango pcre pdf pentax phonon pim plasma png policykit ppds pulseaudio python qml qt5 readline scanner sdl seccomp semantic-desktop smartcard smp spell split-usr sse sse2 sse3 ssl startup-notification subversion svg systemd tcpd tiff touchpad truetype udev udisks unicode upower usb vaapi vim-syntax vorbis wayland widgets wxwidgets x264 xattr xcb xcomposite xml xv xvid zeroconf zlib" ABI_X86="64" ADA_TARGET="gnat_2018" ALSA_CARDS="ali5451 als4000 atiixp atiixp-modem bt87x ca0106 cmipci emu10k1x ens1370 ens1371 es1938 es1968 fm801 hda-intel intel8x0 intel8x0m maestro3 trident usb-audio via82xx via82xx-modem ymfpci" APACHE2_MODULES="authn_core authz_core socache_shmcb unixd actions alias auth_basic authn_alias authn_anon authn_dbm authn_default authn_file authz_dbm authz_default authz_groupfile authz_host authz_owner authz_user autoindex cache cgi cgid dav dav_fs dav_lock deflate dir disk_cache env expires ext_filter file_cache filter headers include info log_config logio mem_cache mime mime_magic negotiation rewrite setenvif speling status unique_id userdir usertrack vhost_alias" CALLIGRA_FEATURES="karbon sheets words" COLLECTD_PLUGINS="df interface irq load memory rrdtool swap syslog" CPU_FLAGS_X86="mmx mmxext sse sse2" ELIBC="glibc" GPSD_PROTOCOLS="ashtech aivdm earthmate evermore fv18 garmin garmintxt gpsclock greis isync itrax mtk3301 nmea ntrip navcom oceanserver oldstyle oncore rtcm104v2 rtcm104v3 sirf skytraq superstar2 timing tsip tripmate tnt ublox ubx" INPUT_DEVICES="evdev mouse keyboard" KERNEL="linux" L10N="en de" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" LIBREOFFICE_EXTENSIONS="presenter-console presenter-minimizer" OFFICE_IMPLEMENTATION="libreoffice" PHP_TARGETS="php7-2" POSTGRES_TARGETS="postgres10 postgres11" PYTHON_SINGLE_TARGET="python3_6" PYTHON_TARGETS="python2_7 python3_6 python3_8" RUBY_TARGETS="ruby25 ruby27" USERLAND="GNU" VIDEO_CARDS="intel i965" XTABLES_ADDONS="quota2 psd pknock lscan length2 ipv4options ipset ipp2p iface geoip fuzzy condition tee tarpit sysrq steal rawnat logmark ipmark dhcpmac delude chaos account"
Unset:  CC, CPPFLAGS, CTARGET, CXX, INSTALL_MASK, LC_ALL, LINGUAS, PORTAGE_BINHOST, PORTAGE_BUNZIP2_COMMAND, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS, PORTAGE_RSYNC_EXTRA_OP




Comment 1


Andreas Sturmlechner






          2020-03-07 09:41:10 UTC
        

I just ran the same update, and Plasma 5.18.2 runs fine for me.




Comment 2


Mark Nowiasz





          2020-03-07 10:32:16 UTC
        

(In reply to Andreas Sturmlechner from comment #1)
> I just ran the same update, and Plasma 5.18.2 runs fine for me.

Well, I can give you some more information. I'm running this setup:
A laptop connected to a larger monitor which is Plasma's primary display (the Laptop's screen is secondary).

During a emerge -uDN (libglvnd was just installed) the screensaver got activated and all I got was the "failed to unlock... use loginctl unlocksession.." screen (the one you usually get when you are in the middle of updating qt).

This time I wasn't able to switch to a virtual console, however I was able to use my phone to ssh into the laptop and then issue a loginctl unlocksessions and the screen unlocked. However, Plasma was in odd state - no windows, no bar, there was just a hint of one of the windows - a uttermost left part of it was partly visible on the main screen. It was as if there was a *third* screen right to main screen. I wasn't able to do anything apart from moving the mouse, so I rebooted - and sddm-greeter was unable to work.

As a wild guess: It seems that the combination (libglvnd, mesa, xorg) is unable to detect the screens properly. The sddm log (issued when I tried to start sddm manually as root) seems also to support this theory:

[10:06:00.983] (II) DAEMON: Running: /usr/bin/X -nolisten tcp -auth /var/run/sddm/{eb662282-36ef-425f-99df-77123183cf9f} -background none -noreset -displayfd 17 -seat seat0 vt1
[10:06:01.095] (EE) DAEMON: Failed to read display number from pipe
[10:06:01.096] (EE) DAEMON: Display server failed to start. Exiting
[10:11:15.708] (II) DAEMON: Initializing...
[10:11:15.713] (II) DAEMON: Starting...
[10:11:15.714] (II) DAEMON: Logind interface found
[10:11:15.715] (II) DAEMON: Adding new display on vt 1 ...
[10:11:15.715] (II) DAEMON: Loading theme configuration from ""
[10:11:15.715] (II) DAEMON: Display server starting...
[10:11:15.715] (II) DAEMON: Running: /usr/bin/X -nolisten tcp -auth /var/run/sddm/{cc2b9aa6-dc06-497c-98b5-d72fc2f71139} -background none -noreset -displayfd 17 -seat seat0 vt1
[10:11:16.119] (EE) DAEMON: Failed to read display number from pipe
[10:11:16.119] (EE) DAEMON: Display server failed to start. Exiting




Comment 3


Matt Turner






          2020-03-09 00:09:30 UTC
        

I expect you at least need to restart X. Are the problems fixed after doing that?




Comment 4


Mark Nowiasz





          2020-03-09 03:55:18 UTC
        

(In reply to Matt Turner from comment #3)
> I expect you at least need to restart X. Are the problems fixed after doing
> that?

<Sarcasmmode>Well, if numerous reboots (and manual restarting sddm) to find out what package caused this malfunction counts as "restart X" I reckon that the problems weren't fixed after doing that, as stated above:

> After rebooting, sddm stopped working, too - so I was unable to login 
</Sarcasmode>

I'm not in the habit of issueing bug reports that a simple "Have you tried turn it on and off" would fix.




Comment 5


Matt Turner






          2020-03-09 04:40:09 UTC
        

My apologies. I've looked at a huge number of bugs today...




Comment 6


Matt Turner






          2020-03-09 04:41:28 UTC
        

To confirm,  you have libglvnd, mesa[libglvnd], and xorg-server[libglvnd] installed? (And nvidia-drivers[libglvnd] if you have nvidia-drivers)




Comment 7


Mark Nowiasz





          2020-03-09 09:32:24 UTC
        

(In reply to Matt Turner from comment #6)
> To confirm,  you have libglvnd, mesa[libglvnd], and xorg-server[libglvnd]
> installed? (And nvidia-drivers[libglvnd] if you have nvidia-drivers)

I had, and it was not working - it created havoc with Plasma: I was unable to unlock the screen, after unlocking it via loginctl unlocksessions the windows/bars have vanished (probably moved to the uttermost right of the screen) After reboot sddm (in fact, sddm-greeter) didn't work, either.

The only way to fix it was adding "-libglvnd" to USE in /etc/portage/make.conf and reinstalling xorg and mesa (20.0.0, 20.0.1 caused permanent @presevered-rebuild, even after running through, but that's another story) it worked again.

I'm not using nvidia-drivers, I'm using intel/i965.

Some more information: On another machine libglvnd works just fine - even with intel/i965, however this machine isn't running Plasma - just xbmc via X.

Some more information: I had an emerge -uDN running, about 17 packages. I let the laptop do it's work, screensaver was activated and then the "unable to unlock session"-Screen came on when I tried to unlock it - with the result I described before. I tried to pinpoint the package and came to libglvnd. However, a simple emerge --unmerge libglvnd didn't suffice - after doing that an rebooting sddm-greeter still didn't work. Only after USE="-libglvnd" emerge -1 xorg mesa it worked again.

What's so puzzling: mesa/xorg worked just fine *before* libglvnd was installed. After that Plasma broke down - even unmerging libglvnd had no effect. To be honest, I have no idea what exactly went wrong, hence the quite verbose bug report




Comment 8


Mark Nowiasz





          2020-03-14 11:27:20 UTC
        

After taking some precautions - taking a snapshot of /'s filesystem so I could easily revert - I've disabled the "-libglvnd" and did a emerge -uDN @world @system, installing libglvnd during the process plus recompiling xorg/mesa.

Guess what? This time everything worked without a problem. I still don't understand what exactly caused these problem the first time :-/




Comment 9


Matt Turner






          2020-03-14 16:07:04 UTC
        

(In reply to Mark Nowiasz from comment #8)
> After taking some precautions - taking a snapshot of /'s filesystem so I
> could easily revert - I've disabled the "-libglvnd" and did a emerge -uDN
> @world @system, installing libglvnd during the process plus recompiling
> xorg/mesa.
> 
> Guess what? This time everything worked without a problem. I still don't
> understand what exactly caused these problem the first time :-/

Ugh, that's the worst :|

Thanks for following up!









Format For Printing
 - XML
 - Clone This Bug
 - Clone In The Same 
                        Product
 - Top of page 







Home
| New–[Ex]
| Browse
| Search
| Privacy Policy

| 





[?]
| Reports

| 
Requests

| 
Help


| 
New Account


| 
Log In





[x]



| 
Forgot Password

Login:




[x]

